<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thierry Carles - Gestion du Personnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #3d3573;
            --secondary: #e84597;
            --accent: #c1439d;
            --bg-dark: #1a1633;
            --bg-light: #f8f7fc;
            --text-dark: #2a2547;
            --text-light: #6b6885;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e8e6f0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #fff 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        .app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #2d2558 100%);
            padding: 24px 32px;
            border-radius: 20px;
            margin-bottom: 28px;
            box-shadow: 0 20px 60px rgba(61, 53, 115, 0.25);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(232, 69, 151, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            z-index: 1;
        }
        .header-logo {
            height: 48px;
        }
        .header-title {
            color: white;
            font-family: 'Manrope', sans-serif;
        }
        .header-title h1 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 2px;
        }
        .header-title p {
            font-size: 13px;
            opacity: 0.8;
            font-weight: 400;
        }
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 9px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        .unsaved-badge {
            background: rgba(255, 193, 7, 0.2);
            color: #fff;
            padding: 7px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        /* ===== LOGIN ===== */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1633 0%, #2d2558 50%, #3d3573 100%);
            position: relative;
            overflow: hidden;
        }
        .login-page::before {
            content: '';
            position: absolute;
            top: -30%;
            left: -20%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(232, 69, 151, 0.12) 0%, transparent 70%);
            border-radius: 50%;
        }
        .login-page::after {
            content: '';
            position: absolute;
            bottom: -25%;
            right: -15%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(61, 53, 115, 0.3) 0%, transparent 70%);
            border-radius: 50%;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 48px 42px 42px;
            border-radius: 28px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        .login-logo-wrap {
            text-align: center;
            margin-bottom: 28px;
        }
        .login-logo {
            height: 70px;
        }
        .login-container h2 {
            color: var(--primary);
            margin-bottom: 6px;
            font-size: 26px;
            font-weight: 800;
            font-family: 'Manrope', sans-serif;
            text-align: center;
        }
        .login-container>p {
            color: var(--text-light);
            margin-bottom: 28px;
            font-size: 14px;
            text-align: center;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 7px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 13px;
        }
        .input-group input {
            width: 100%;
            padding: 13px 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 4px rgba(232, 69, 151, 0.1);
        }
        .primary-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(232, 69, 151, 0.3);
        }
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(232, 69, 151, 0.4);
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 6px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-light);
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .tab.active {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(232, 69, 151, 0.3);
        }
        .tab:hover:not(.active) {
            background: var(--bg-light);
        }

        /* ===== CARDS ===== */
        .card {
            background: white;
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
        }
        .card h3 {
            color: var(--primary);
            margin-bottom: 18px;
            font-size: 20px;
            font-weight: 700;
            font-family: 'Manrope', sans-serif;
        }

        /* ===== STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        .stat-card.present {
            border-left-color: var(--success);
        }
        .stat-card.late {
            border-left-color: var(--warning);
        }
        .stat-card.absent {
            border-left-color: var(--danger);
        }
        .stat-card h4 {
            color: var(--text-light);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 38px;
            font-weight: 800;
            color: var(--text-dark);
            font-family: 'Manrope', sans-serif;
            margin-bottom: 6px;
        }
        .stat-card .list {
            color: var(--text-light);
            font-size: 13px;
            max-height: 80px;
            overflow-y: auto;
        }

        /* ===== CHANTIERS EN COURS (DASHBOARD) ===== */
        .chantiers-dashboard {
            background: white;
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
        }
        .chantiers-dashboard h3 {
            color: var(--primary);
            margin-bottom: 18px;
            font-size: 20px;
            font-weight: 700;
            font-family: 'Manrope', sans-serif;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chantier-dashboard-item {
            background: linear-gradient(135deg, var(--bg-light) 0%, white 100%);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--secondary);
            transition: all 0.3s ease;
        }
        .chantier-dashboard-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(232, 69, 151, 0.15);
        }
        .chantier-dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 14px;
        }
        .chantier-dashboard-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 6px;
        }
        .chantier-dashboard-lieu {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        .chantier-dashboard-dates {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 500;
        }
        .chantier-dashboard-zone-badge {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chantier-employees-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 14px;
        }
        .chantier-employee-badge {
            background: white;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chantier-employee-badge::before {
            content: 'ðŸ‘·';
            font-size: 16px;
        }

        /* ===== EMPLOYEES ===== */
        .employee-list {
            display: grid;
            gap: 12px;
        }
        .employee-item {
            background: var(--bg-light);
            padding: 16px 20px;
            border-radius: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .employee-item:hover {
            background: #f0eef8;
            transform: translateX(3px);
        }
        .employee-info h4 {
            color: var(--text-dark);
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 15px;
        }
        .employee-info p {
            color: var(--text-light);
            font-size: 12px;
        }
        .employee-actions {
            display: flex;
            gap: 6px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 9px 16px;
            border: none;
            border-radius: 9px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .btn-edit {
            background: var(--primary);
            color: white;
        }
        .btn-edit:hover {
            background: #2d2558;
            transform: translateY(-1px);
        }
        .btn-delete {
            background: var(--danger);
            color: white;
        }
        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 2px solid var(--border);
        }
        .btn-secondary:hover {
            background: #f0eef8;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        /* ===== FORMS ===== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 13px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 11px 13px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(232, 69, 151, 0.1);
        }

        /* ===== SCHEDULE ===== */
        .schedule-grid {
            display: grid;
            gap: 8px;
            margin-top: 12px;
        }
        .schedule-day {
            display: grid;
            grid-template-columns: 100px 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: var(--bg-light);
            border-radius: 10px;
        }
        .schedule-day label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 13px;
        }
        .time-inputs {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .time-inputs input {
            flex: 1;
            padding: 7px 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal {
            background: white;
            padding: 36px;
            border-radius: 24px;
            max-width: 620px;
            width: 92%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 22px;
            font-weight: 700;
            font-family: 'Manrope', sans-serif;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }
        .modal-actions button {
            flex: 1;
        }

        /* ===== CHANTIERS ===== */
        .chantier-item {
            background: var(--bg-light);
            padding: 18px;
            border-radius: 14px;
            margin-bottom: 14px;
            border-left: 4px solid var(--primary);
        }
        .chantier-item h4 {
            color: var(--text-dark);
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 15px;
        }
        .chantier-item p {
            color: var(--text-light);
            font-size: 13px;
            margin-bottom: 3px;
        }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }
        .badge-zone {
            background: rgba(232, 69, 151, 0.15);
            color: var(--accent);
        }
        .employee-assignments {
            margin-top: 14px;
            padding: 14px;
            background: white;
            border-radius: 10px;
            border: 2px solid var(--border);
        }
        .assignment-item {
            padding: 10px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .assignment-item:last-child {
            margin-bottom: 0;
        }

        /* ===== EXPORT ===== */
        .export-section {
            background: linear-gradient(135deg, var(--bg-light) 0%, white 100%);
            padding: 20px;
            border-radius: 16px;
            border: 2px dashed var(--border);
        }
        .export-section h4 {
            color: var(--primary);
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 15px;
        }

        /* ===== MESSAGES ===== */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 11px 15px;
            border-radius: 10px;
            margin-bottom: 14px;
            font-size: 13px;
            border-left: 4px solid var(--danger);
        }
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            padding: 11px 15px;
            border-radius: 10px;
            margin-bottom: 14px;
            font-size: 13px;
            border-left: 4px solid var(--success);
        }

        /* ===== CP SUMMARY ===== */
        .cp-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .cp-card {
            background: linear-gradient(135deg, #f0eef8, white);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .cp-card .cp-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .cp-card .cp-value {
            font-size: 24px;
            font-weight: 800;
            font-family: 'Manrope', sans-serif;
            color: var(--primary);
        }
        .cp-card .cp-value.danger {
            color: var(--danger);
        }
        .cp-card .cp-value.warning {
            color: var(--warning);
        }

        /* ===== EMPLOYEE DETAIL PANEL ===== */
        .detail-panel {
            background: white;
            border-radius: 16px;
            border: 2px solid var(--border);
            overflow: hidden;
            margin-top: 16px;
        }
        .detail-panel-header {
            background: linear-gradient(135deg, var(--primary), #2d2558);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-panel-header h4 {
            font-size: 15px;
            font-weight: 700;
            font-family: 'Manrope', sans-serif;
        }
        .detail-panel-body {
            padding: 20px;
        }
        .detail-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
        }
        .detail-tab {
            padding: 7px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-light);
            color: var(--text-light);
            transition: all 0.2s;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .detail-tab.active {
            background: var(--primary);
            color: white;
        }
        .detail-tab:hover:not(.active) {
            background: #e8e6f0;
        }
        .absence-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 6px;
        }
        .absence-list-item .motif-tag {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .motif-cp {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        .motif-maladie {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }
        .motif-other {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--text-light);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 14px;
                text-align: center;
            }
            .tabs {
                flex-direction: column;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .schedule-day {
                grid-template-columns: 1fr;
            }
            .login-container {
                padding: 36px 28px 32px;
            }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // â”€â”€â”€ AUTH STORAGE â”€â”€â”€
        const AUTH_KEY = 'tc_auth';
        function getStoredAuth() {
            try {
                const raw = localStorage.getItem(AUTH_KEY);
                return raw ? JSON.parse(raw) : { username: 'admin', password: 'admin' };
            } catch { return { username: 'admin', password: 'admin' }; }
        }
        function setStoredAuth(obj) {
            try { localStorage.setItem(AUTH_KEY, JSON.stringify(obj)); } catch { }
        }

        // â”€â”€â”€ DATA STORAGE â”€â”€â”€
        const DATA_KEY = 'tc_data';
        function getStoredData() {
            try {
                const raw = localStorage.getItem(DATA_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch { return null; }
        }
        function setStoredData(obj) {
            try { localStorage.setItem(DATA_KEY, JSON.stringify(obj)); } catch { }
        }

        // â”€â”€â”€ UTILS â”€â”€â”€
        function countWorkDays(startStr, endStr) {
            let count = 0;
            const start = new Date(startStr + 'T00:00:00');
            const end = new Date(endStr + 'T00:00:00');
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dow = d.getDay();
                if (dow !== 0 && dow !== 6) count++;
            }
            return count;
        }

        function getMonthlyCP(absences, employeeId, year, month) {
            return absences.filter(a => {
                if (a.employeeId !== employeeId || a.motif !== 'CongÃ©s payÃ©s') return false;
                const start = new Date(a.dateDebut + 'T00:00:00');
                const end = new Date(a.dateFin + 'T00:00:00');
                const mStart = new Date(year, month, 1);
                const mEnd = new Date(year, month + 1, 0);
                return start <= mEnd && end >= mStart;
            }).reduce((total, a) => {
                const start = new Date(a.dateDebut + 'T00:00:00');
                const end = new Date(a.dateFin + 'T00:00:00');
                const mStart = new Date(year, month, 1);
                const mEnd = new Date(year, month + 1, 0);
                const effStart = start > mStart ? start : mStart;
                const effEnd = end < mEnd ? end : mEnd;
                let days = 0;
                for (let d = new Date(effStart); d <= effEnd; d.setDate(d.getDate() + 1)) {
                    const dow = d.getDay();
                    if (dow !== 0 && dow !== 6) days++;
                }
                return total + days;
            }, 0);
        }

        function computeCPBalance(employee, absences) {
            const now = new Date();
            const year = now.getFullYear();
            const currentMonth = now.getMonth();
            const startMonth = employee.cpStartMonth !== undefined ? employee.cpStartMonth : 0;
            const cpBase = employee.cpBase || 25;
            const monthsElapsed = currentMonth - startMonth + 1;
            const accumulated = Math.max(0, monthsElapsed) * 2.5;
            let used = 0;
            for (let m = 0; m <= 11; m++) {
                used += getMonthlyCP(absences, employee.id, year, m);
            }
            return {
                base: cpBase,
                accumulated: parseFloat(accumulated.toFixed(1)),
                used,
                balance: parseFloat((cpBase + accumulated - used).toFixed(1))
            };
        }

        // â”€â”€â”€ GEOLOCATION â”€â”€â”€
        const COMPANY_LAT = 50.3333, COMPANY_LON = 3.5833;
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        function getZone(address) {
            const postalCode = address.match(/\d{5}/)?.[0];
            if (!postalCode) return { zone: 1, panier: 0 };
            const lat = 50.3 + Math.random() * 2;
            const lon = 3.5 + Math.random() * 2;
            const distance = calculateDistance(COMPANY_LAT, COMPANY_LON, lat, lon);
            if (distance < 10) return { zone: 0, panier: 0 };
            if (distance < 30) return { zone: 1, panier: 7.5 };
            if (distance < 60) return { zone: 2, panier: 12.5 };
            return { zone: 3, panier: 17.5 };
        }

        // â”€â”€â”€ NOUVELLE FONCTION CHANTIERS ACTIFS â”€â”€â”€
        const getActiveChantiers = (chantiers) => {
            const today = new Date().toISOString().split('T')[0];
            return chantiers.filter(c => {
                const start = new Date(c.dateDebut + 'T00:00:00');
                const end = new Date(c.dateFin + 'T00:00:00');
                const todayDate = new Date(today + 'T00:00:00');
                return todayDate >= start && todayDate <= end;
            });
        };

        // â”€â”€â”€ APP â”€â”€â”€
        function App() {
            const [authenticated, setAuthenticated] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [employees, setEmployees] = useState([]);
            const [chantiers, setChantiers] = useState([]);
            const [absences, setAbsences] = useState([]);
            const [retards, setRetards] = useState([]);
            const [heuresSupp, setHeuresSupp] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [showChantierModal, setShowChantierModal] = useState(false);
            const [editingChantier, setEditingChantier] = useState(null);
            const [message, setMessage] = useState(null);
            const [needsSave, setNeedsSave] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);

            useEffect(() => {
                const saved = getStoredData();
                if (saved) {
                    if (saved.employees) setEmployees(saved.employees);
                    if (saved.chantiers) setChantiers(saved.chantiers);
                    if (saved.absences) setAbsences(saved.absences);
                    if (saved.retards) setRetards(saved.retards);
                    if (saved.heuresSupp) setHeuresSupp(saved.heuresSupp);
                }
            }, []);

            useEffect(() => {
                const allData = { employees, chantiers, absences, retards, heuresSupp, lastSaved: new Date().toISOString() };
                setStoredData(allData);
                if (employees.length > 0 || chantiers.length > 0 || absences.length > 0) {
                    setNeedsSave(true);
                }
            }, [employees, chantiers, absences, retards, heuresSupp]);

            // â”€â”€â”€ SAVE / LOAD FILE â”€â”€â”€
            const fileHandleRef = React.useRef(null);
            const getDataBlob = () => {
                const allData = { employees, chantiers, absences, retards, heuresSupp, lastSaved: new Date().toISOString() };
                return new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            };

            const saveDataToFile = async () => {
                try {
                    if (window.showSaveFilePicker) {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: 'thierry-carles-data.json',
                            types: [{ description: 'Fichier donnÃ©es JSON', accept: { 'application/json': ['.json'] } }]
                        });
                        const writable = await handle.createWritable();
                        await writable.write(getDataBlob());
                        await writable.close();
                        fileHandleRef.current = handle;
                        setNeedsSave(false);
                        setMessage({ type: 'success', text: `EnregistrÃ© : ${handle.name}` });
                        setTimeout(() => setMessage(null), 3000);
                    } else {
                        const url = URL.createObjectURL(getDataBlob());
                        const link = document.createElement('a');
                        link.href = url; link.download = 'thierry-carles-data.json'; link.click();
                        URL.revokeObjectURL(url);
                        setNeedsSave(false);
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        setMessage({ type: 'error', text: 'Erreur lors de la sauvegarde' });
                        setTimeout(() => setMessage(null), 3000);
                    }
                }
            };

            const loadDataFromFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.employees) setEmployees(data.employees);
                        if (data.chantiers) setChantiers(data.chantiers);
                        if (data.absences) setAbsences(data.absences);
                        if (data.retards) setRetards(data.retards);
                        if (data.heuresSupp) setHeuresSupp(data.heuresSupp);
                        setMessage({ type: 'success', text: 'DonnÃ©es chargÃ©es avec succÃ¨s' });
                        setTimeout(() => setMessage(null), 3000);
                    } catch {
                        setMessage({ type: 'error', text: 'Erreur lors du chargement' });
                        setTimeout(() => setMessage(null), 3000);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // â”€â”€â”€ AUTH â”€â”€â”€
            const handleLogin = (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                const creds = getStoredAuth();
                if (username === creds.username && password === creds.password) {
                    setAuthenticated(true);
                } else {
                    setMessage({ type: 'error', text: 'Identifiants incorrects' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            const changePassword = (oldPwd, newPwd) => {
                const creds = getStoredAuth();
                if (oldPwd !== creds.password) {
                    setMessage({ type: 'error', text: 'Ancien mot de passe incorrect' });
                    setTimeout(() => setMessage(null), 3000);
                    return false;
                }
                setStoredAuth({ ...creds, password: newPwd });
                setMessage({ type: 'success', text: 'Mot de passe changÃ© avec succÃ¨s' });
                setTimeout(() => setMessage(null), 3000);
                setShowPasswordModal(false);
                return true;
            };

            // â”€â”€â”€ STATS â”€â”€â”€
            const getTodayStats = () => {
                const today = new Date().toISOString().split('T')[0];
                const todayRetards = retards.filter(r => r.date === today);
                const todayAbsences = absences.filter(a => {
                    const s = new Date(a.dateDebut + 'T00:00:00');
                    const f = new Date(a.dateFin + 'T00:00:00');
                    const t = new Date(today + 'T00:00:00');
                    return t >= s && t <= f;
                });
                const present = employees.length - todayAbsences.length;
                const late = todayRetards.length;
                const absent = todayAbsences.length;
                const lateEmployees = todayRetards.map(r => {
                    const emp = employees.find(e => e.id === r.employeeId);
                    return emp ? `${emp.nom} (${r.minutes} min)` : '';
                }).filter(Boolean);
                const absentEmployees = todayAbsences.map(a => {
                    const emp = employees.find(e => e.id === a.employeeId);
                    return emp ? `${emp.nom} (${a.motif})` : '';
                }).filter(Boolean);
                return { present, late, absent, lateEmployees, absentEmployees };
            };

            // â”€â”€â”€ EMPLOYEES CRUD â”€â”€â”€
            const saveEmployee = (empData) => {
                if (editingEmployee) {
                    setEmployees(employees.map(e => e.id === editingEmployee.id ? empData : e));
                    setMessage({ type: 'success', text: 'EmployÃ© modifiÃ©' });
                } else {
                    setEmployees([...employees, { ...empData, id: Date.now().toString(), cpBase: empData.cpBase || 25, cpStartMonth: new Date().getMonth() }]);
                    setMessage({ type: 'success', text: 'EmployÃ© ajoutÃ©' });
                }
                setShowModal(false); setEditingEmployee(null);
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteEmployee = (id) => {
                if (confirm('Supprimer cet employÃ© ?')) {
                    setEmployees(employees.filter(e => e.id !== id));
                    setAbsences(absences.filter(a => a.employeeId !== id));
                    setRetards(retards.filter(r => r.employeeId !== id));
                    setHeuresSupp(heuresSupp.filter(h => h.employeeId !== id));
                    setMessage({ type: 'success', text: 'EmployÃ© supprimÃ©' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            // â”€â”€â”€ CHANTIERS CRUD â”€â”€â”€
            const saveChantier = (data) => {
                const zoneInfo = getZone(data.lieu);
                const ch = { ...data, zone: zoneInfo.zone, panier: zoneInfo.panier };
                if (editingChantier) {
                    setChantiers(chantiers.map(c => c.id === editingChantier.id ? ch : c));
                    setMessage({ type: 'success', text: 'Chantier modifiÃ©' });
                } else {
                    setChantiers([...chantiers, { ...ch, id: Date.now().toString() }]);
                    setMessage({ type: 'success', text: 'Chantier ajoutÃ©' });
                }
                setShowChantierModal(false); setEditingChantier(null);
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteChantier = (id) => {
                if (confirm('Supprimer ce chantier ?')) {
                    setChantiers(chantiers.filter(c => c.id !== id));
                    setMessage({ type: 'success', text: 'Chantier supprimÃ©' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            // â”€â”€â”€ EXPORT AMÃ‰LIORÃ‰ â”€â”€â”€
           const exportEmployee = (employeeId) => {
    try {
        const employee = employees.find(e => e.id === employeeId);
        if (!employee) {
            setMessage({ type: 'error', text: 'Aucun employÃ© sÃ©lectionnÃ© ou introuvable' });
            return;
        }

        const wb = XLSX.utils.book_new();
        const year = new Date().getFullYear();
        const months = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];

        // â”€â”€ COULEURS AVEC FF â”€â”€
        const P = 'FF3D3573';
        const S = 'FFE84597';
        const W = 'FFFFFFFF';

        const BG_TITLE   = S;
        const BG_CP      = 'FFF3E8FF';
        const BG_HDR     = P;
        const BG_ROW_A   = 'FFFFFFFF';
        const BG_ROW_B   = 'FFF5F3FA';
        const BG_WEEKEND = 'FFDDDDDD';
        const BG_CP_OK   = 'FFD1FAE5';
        const BG_ABSENT  = 'FFFEE2E2';
        const BG_RETARD  = 'FFFEF3C7';
        const BG_TOTALS  = 'FFEDE9F5';
        const BG_MOTIF   = 'FFF0E6FF';

        // â”€â”€ Bordures (thick â†’ medium pour meilleure compatibilitÃ©) â”€â”€
        const bThin = { style: 'thin', color: { rgb: 'FFB0AEC0' } };
        const bMed  = { style: 'medium', color: { rgb: P } };
        const bThick = { style: 'medium', color: { rgb: P } }; // â† modifiÃ©
        const bWhite = { style: 'thin', color: { rgb: W } };
        const bAll = (s) => ({ top: s, bottom: s, left: s, right: s });
        const bCell = bAll(bThin);
        const bHdr = bAll(bWhite);
        const bTitle = bAll(bThick);
        const bTotals = bAll(bMed);
        const bLastData = { top: bThin, bottom: bThick, left: bThin, right: bThin };

        // â”€â”€ Polices (avec FF pour les couleurs de texte) â”€â”€
        const fTitle = { bold: true, color: { rgb: W }, sz: 16, name: 'Calibri' };
        const fCpLabel = { bold: true, color: { rgb: P }, sz: 11, name: 'Calibri' };
        const fCpValue = { bold: true, color: { rgb: P }, sz: 14, name: 'Calibri' };
        const fHdr = { bold: true, color: { rgb: W }, sz: 12, name: 'Calibri' };
        const fNormal = { color: { rgb: 'FF2A2547' }, sz: 11, name: 'Calibri' };
        const fBold = { bold: true, color: { rgb: 'FF2A2547' }, sz: 11, name: 'Calibri' };
        const fWeekend = { color: { rgb: 'FF6B7280' }, sz: 11, name: 'Calibri', italic: true };
        const fAbsent = { bold: true, color: { rgb: 'FFB91C1C' }, sz: 11, name: 'Calibri' };
        const fTotLabel = { bold: true, color: { rgb: P }, sz: 12, name: 'Calibri' };
        const fTotValue = { bold: true, color: { rgb: P }, sz: 14, name: 'Calibri' };
        const fMotifHdr = { bold: true, color: { rgb: W }, sz: 11, name: 'Calibri' };

        const fill = (hex) => ({ patternType: 'solid', fgColor: { rgb: hex } });
        const centerH = { horizontal: 'center', vertical: 'center' };
        const leftH = { horizontal: 'left', vertical: 'center' };
        const rightH = { horizontal: 'right', vertical: 'center' };

        const cpBal = computeCPBalance(employee, absences);

        months.forEach((monthName, monthIndex) => {
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const ws = {};
            ws['!merges'] = [];
            let row = 0;
            const COLS = 8;

            // ROW 0 : Titre avec bordure
            ws[XLSX.utils.encode_cell({ c: 0, r: row })] = {
                v: `Planning â€“ ${employee.nom} â€“ ${monthName} ${year}`, t: 's',
                s: { font: fTitle, fill: fill(BG_TITLE), alignment: centerH, border: bTitle }
            };
            for (let c = 1; c < COLS; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = {
                v: '', t: 's', s: { fill: fill(BG_TITLE), border: bTitle }
            };
            ws['!merges'].push({ s: { c: 0, r: row }, e: { c: COLS - 1, r: row } });
            row++;

            // CP rÃ©sumÃ©
            const cpItems = [
                { label: 'CP de base (annÃ©e)', value: String(cpBal.base) },
                { label: 'AccumulÃ©s (+2.5/mois)', value: '+' + cpBal.accumulated },
                { label: 'UtilisÃ©s', value: String(cpBal.used) },
                { label: 'Solde CP', value: String(cpBal.balance) }
            ];

            cpItems.forEach((item, i) => {
                const c = i * 2;
                ws[XLSX.utils.encode_cell({ c, r: row })] = {
                    v: item.label, t: 's',
                    s: { font: fCpLabel, fill: fill(BG_CP), alignment: centerH, border: bTotals }
                };
                ws[XLSX.utils.encode_cell({ c: c + 1, r: row })] = { v: '', t: 's', s: { fill: fill(BG_CP), border: bTotals } };
                ws['!merges'].push({ s: { c, r: row }, e: { c: c + 1, r: row } });
            });
            row++;

            cpItems.forEach((item, i) => {
                const c = i * 2;
                const isNeg = cpBal.balance < 0 && i === 3;
                ws[XLSX.utils.encode_cell({ c, r: row })] = {
                    v: item.value, t: 's',
                    s: { font: { ...fCpValue, color: { rgb: isNeg ? 'FFEF4444' : P } }, fill: fill(BG_CP), alignment: centerH, border: bTotals }
                };
                ws[XLSX.utils.encode_cell({ c: c + 1, r: row })] = { v: '', t: 's', s: { fill: fill(BG_CP), border: bTotals } };
                ws['!merges'].push({ s: { c, r: row }, e: { c: c + 1, r: row } });
            });
            row++;

            // En-tÃªte
            const headers = ['Date', 'Jour', 'Heures', 'Chantier', 'Zone', 'Panier (â‚¬)', 'Retard (min)', 'Absence'];
            headers.forEach((h, c) => {
                ws[XLSX.utils.encode_cell({ c, r: row })] = {
                    v: h, t: 's',
                    s: { font: fHdr, fill: fill(BG_HDR), alignment: centerH, border: bHdr }
                };
            });
            row++;

            const dataStartRow = row;
            let totalHeures = 0, totalPanier = 0, totalHeuresSupp = 0, totalRetards = 0, totalConges = 0;
            let absencesByMotif = {};

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, monthIndex, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const dayNamesLow = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
                const dayOfWeek = dayNames[date.getDay()];
                const dayName = dayNamesLow[date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isLastDay = (day === daysInMonth);
                const dateFormatted = `${String(day).padStart(2, '0')} ${monthName.toLowerCase()} ${year}`;
                const absence = absences.find(a => a.employeeId === employeeId &&
                    new Date(a.dateDebut + 'T00:00:00') <= date &&
                    new Date(a.dateFin + 'T00:00:00') >= date);
                let rowData, bg, font;
                const altBg = (day % 2 === 0) ? BG_ROW_B : BG_ROW_A;
                if (absence) {
                    rowData = [dateFormatted, dayOfWeek, '', '', '', '', '', absence.motif];
                    bg = (absence.motif === 'CongÃ©s payÃ©s') ? BG_CP_OK : BG_ABSENT;
                    font = fAbsent;
                    if (absence.motif === 'CongÃ©s payÃ©s') totalConges++;
                    absencesByMotif[absence.motif] = (absencesByMotif[absence.motif] || 0) + 1;
                } else if (isWeekend) {
                    rowData = [dateFormatted, dayOfWeek, '', '', '', '', '', 'Repos'];
                    bg = BG_WEEKEND;
                    font = fWeekend;
                } else {
                    const schedule = employee.horaires?.[dayName];
                    if (!schedule || !schedule.debut || !schedule.fin) {
                        rowData = [dateFormatted, dayOfWeek, '', '', '', '', '', 'Jour off'];
                        bg = BG_WEEKEND;
                        font = fWeekend;
                    } else {
                        const debut = new Date(`2000-01-01T${schedule.debut}`);
                        const fin = new Date(`2000-01-01T${schedule.fin}`);
                        let heures = (fin - debut) / (1000 * 60 * 60);
                        const chantierAssignment = chantiers.find(c => {
                            const hasEmp = c.employees?.some(e => e.employeeId === employeeId &&
                                new Date(e.dateDebut + 'T00:00:00') <= date &&
                                new Date(e.dateFin + 'T00:00:00') >= date);
                            return hasEmp && new Date(c.dateDebut + 'T00:00:00') <= date &&
                                new Date(c.dateFin + 'T00:00:00') >= date;
                        });
                        const chantierNom = chantierAssignment?.nom || '';
                        const zone = chantierAssignment?.zone !== undefined ? chantierAssignment.zone : '';
                        const panier = chantierAssignment?.panier || 0;
                        const retard = retards.find(r => r.employeeId === employeeId && r.date === dateStr);
                        const retardMinutes = retard?.minutes || 0;
                        const hSupp = heuresSupp.find(h => h.employeeId === employeeId && h.date === dateStr);
                        if (hSupp) {
                            if (hSupp.type === 'arrivee') {
                                const hr = new Date(`2000-01-01T${hSupp.heureReelle}`);
                                heures += (debut - hr) / (1000 * 60 * 60);
                            } else {
                                const hr = new Date(`2000-01-01T${hSupp.heureReelle}`);
                                heures += (hr - fin) / (1000 * 60 * 60);
                            }
                            totalHeuresSupp += Math.abs(
                                hSupp.heureReelle && schedule[hSupp.type === 'arrivee' ? 'debut' : 'fin'] ?
                                (new Date(`2000-01-01T${hSupp.heureReelle}`) -
                                 new Date(`2000-01-01T${schedule[hSupp.type === 'arrivee' ? 'debut' : 'fin']}`)) / (1000 * 60 * 60) : 0
                            );
                        }
                        totalHeures += heures;
                        totalPanier += panier;
                        totalRetards += retardMinutes;
                        rowData = [dateFormatted, dayOfWeek, parseFloat(heures.toFixed(2)), chantierNom, zone, panier, retardMinutes, ''];
                        bg = retardMinutes > 0 ? BG_RETARD : altBg;
                        font = retardMinutes > 0 ? fBold : fNormal;
                    }
                }
                const rowBorder = isLastDay ? bLastData : bCell;
                rowData.forEach((val, c) => {
                    const isNum = typeof val === 'number';
                    const align = (c === 0 || c === 1 || c === 3 || c === 7) ? leftH : rightH;
                    ws[XLSX.utils.encode_cell({ c, r: row })] = {
                        v: val, t: isNum ? 'n' : 's',
                        s: {
                            font,
                            fill: fill(bg),
                            border: rowBorder,
                            alignment: align,
                            numFmt: (c === 2 || c === 6) ? '0.00' : (c === 5 ? '#,##0.00' : undefined)
                        }
                    };
                });
                row++;
            }
            row++; // ligne vide
            // RÃ‰SUMÃ‰ DU MOIS avec bordure
            ws[XLSX.utils.encode_cell({ c: 0, r: row })] = {
                v: 'RÃ‰SUMÃ‰ DU MOIS', t: 's',
                s: { font: { bold: true, sz: 14, color: { rgb: W }, name: 'Calibri' },
                     fill: fill(BG_HDR), alignment: centerH, border: bThick }
            };
            for (let c = 1; c < COLS; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = {
                v: '', t: 's', s: { fill: fill(BG_HDR), border: bThick }
            };
            ws['!merges'].push({ s: { c: 0, r: row }, e: { c: COLS - 1, r: row } });
            row++;
            const totalsData = [
                ['Total heures travaillÃ©es', totalHeures.toFixed(2) + ' h'],
                ['Montant paniers', totalPanier.toFixed(2) + ' â‚¬'],
                ['Heures supplÃ©mentaires', totalHeuresSupp.toFixed(2) + ' h'],
                ['CongÃ©s payÃ©s utilisÃ©s', totalConges + ' jour' + (totalConges !== 1 ? 's' : '')],
                ['Total retards', totalRetards + ' min']
            ];
            totalsData.forEach(([label, value], idx) => {
                ws[XLSX.utils.encode_cell({ c: 0, r: row })] = {
                    v: label, t: 's',
                    s: { font: fTotLabel, fill: fill(BG_TOTALS), alignment: leftH, border: bTotals }
                };
                ws[XLSX.utils.encode_cell({ c: 1, r: row })] = { v: '', t: 's', s: { fill: fill(BG_TOTALS), border: bTotals } };
                ws['!merges'].push({ s: { c: 0, r: row }, e: { c: 1, r: row } });
                ws[XLSX.utils.encode_cell({ c: 2, r: row })] = {
                    v: value, t: 's',
                    s: { font: fTotValue, fill: fill(BG_TOTALS), alignment: rightH, border: bTotals }
                };
                ws[XLSX.utils.encode_cell({ c: 3, r: row })] = { v: '', t: 's', s: { fill: fill(BG_TOTALS), border: bTotals } };
                ws['!merges'].push({ s: { c: 2, r: row }, e: { c: 3, r: row } });
                for (let c = 4; c < COLS; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = {
                    v: '', t: 's', s: { fill: fill(BG_TOTALS), border: bTotals }
                };
                row++;
            });
            if (Object.keys(absencesByMotif).length > 0) {
                row++;
                ws[XLSX.utils.encode_cell({ c: 0, r: row })] = {
                    v: 'ABSENCES PAR MOTIF', t: 's',
                    s: { font: { bold: true, sz: 13, color: { rgb: W }, name: 'Calibri' },
                         fill: fill(P), alignment: centerH, border: bThick }
                };
                for (let c = 1; c < COLS; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = {
                    v: '', t: 's', s: { fill: fill(P), border: bThick }
                };
                ws['!merges'].push({ s: { c: 0, r: row }, e: { c: COLS - 1, r: row } });
                row++;
                ws[XLSX.utils.encode_cell({ c: 0, r: row })] = {
                    v: 'Motif', t: 's',
                    s: { font: fMotifHdr, fill: fill(BG_MOTIF), alignment: leftH, border: bTotals }
                };
                ws[XLSX.utils.encode_cell({ c: 1, r: row })] = {
                    v: 'Jours', t: 's',
                    s: { font: fMotifHdr, fill: fill(BG_MOTIF), alignment: centerH, border: bTotals }
                };
                for (let c = 2; c < COLS; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = {
                    v: '', t: 's', s: { fill: fill(BG_MOTIF), border: bTotals }
                };
                ws['!merges'].push({ s: { c: 2, r: row }, e: { c: COLS - 1, r: row } });
                row++;
                Object.entries(absencesByMotif).forEach(([motif, count]) => {
                    const motifBg = motif === 'CongÃ©s payÃ©s' ? BG_CP_OK : motif === 'Maladie' ? BG_ABSENT : BG_RETARD;
                    ws[XLSX.utils.encode_cell({ c: 0, r: row })] = {
                        v: motif, t: 's',
                        s: { font: fBold, fill: fill(motifBg), alignment: leftH, border: bCell }
                    };
                    ws[XLSX.utils.encode_cell({ c: 1, r: row })] = {
                        v: count, t: 'n',
                        s: { font: { bold: true, sz: 11, color: { rgb: P }, name: 'Calibri' }, fill: fill(motifBg), alignment: centerH, border: bCell }
                    };
                    for (let c = 2; c < COLS; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = {
                        v: '', t: 's', s: { fill: fill(motifBg), border: bCell }
                    };
                    row++;
                });
            }
            ws['!ref'] = XLSX.utils.encode_range({ s: { c: 0, r: 0 }, e: { c: COLS - 1, r: row - 1 } });
            ws['!cols'] = [
                { wch: 18 }, { wch: 13 }, { wch: 10 }, { wch: 24 },
                { wch: 8 }, { wch: 13 }, { wch: 13 }, { wch: 18 }
            ];
            ws['!rows'] = [];
            for (let r = 0; r < row; r++) {
                if (r === 0) ws['!rows'].push({ ht: 35 });
                else if (r <= 2) ws['!rows'].push({ ht: 24 });
                else if (r === 3) ws['!rows'].push({ ht: 24 });
                else ws['!rows'].push({ ht: 20 });
            }
            XLSX.utils.book_append_sheet(wb, ws, monthName);
        });
        XLSX.writeFile(wb, `Planning_${employee.nom}_${year}.xlsx`);
        setMessage({ type: 'success', text: 'Planning exportÃ© avec succÃ¨s' });
        setTimeout(() => setMessage(null), 3000);
    } catch (err) {
        console.error('Erreur lors de l\'export :', err);
        setMessage({ type: 'error', text: 'Erreur lors de l\'export : ' + (err.message || 'Erreur inconnue') });
    }
};
            // â”€â”€â”€ RENDER â”€â”€â”€
            if (!authenticated) {
                return <LoginForm onLogin={handleLogin} message={message} />;
            }

            const stats = getTodayStats();
            const activeChantiersToday = getActiveChantiers(chantiers);

            return (
                <div className="app">
                    <header className="header">
                        <div className="header-left">
                            <img className="header-logo" src="logo.png" />
                        </div>
                        <div className="header-actions">
                            {needsSave && <span className="unsaved-badge">âš ï¸ Non sauvegardÃ©</span>}
                            <input type="file" id="fileInput" accept=".json" style={{ display: 'none' }} onChange={loadDataFromFile} />
                            <button className="logout-btn" onClick={() => document.getElementById('fileInput').click()}>ðŸ“‚ Charger</button>
                            <button className="logout-btn" onClick={saveDataToFile} style={needsSave ? { background: 'rgba(255,193,7,0.3)', borderColor: 'rgba(255,193,7,0.5)', animation: 'pulse 2s infinite' } : {}}>ðŸ’¾ Enregistrer sousâ€¦</button>
                            <button className="logout-btn" onClick={() => setShowPasswordModal(true)}>ðŸ” Mot de passe</button>
                            <button className="logout-btn" onClick={() => setAuthenticated(false)}>DÃ©connexion</button>
                        </div>
                    </header>

                    {message && (
                        <div className={message.type === 'error' ? 'error-message' : 'success-message'}>
                            {message.text}
                        </div>
                    )}

                    <div className="tabs">
                        {[['dashboard', 'Tableau de Bord'], ['employees', 'EmployÃ©s'], ['modifications', 'Modifications'], ['chantiers', 'Chantiers'], ['export', 'Export']].map(([key, label]) => (
                            <button key={key} className={`tab ${activeTab === key ? 'active' : ''}`} onClick={() => setActiveTab(key)}>
                                {label}
                            </button>
                        ))}
                    </div>

                    {activeTab === 'dashboard' && (
                        <Dashboard
                            stats={stats}
                            activeChantiers={activeChantiersToday}
                            employees={employees}
                        />
                    )}

                    {activeTab === 'employees' && (
                        <EmployeesTab
                            employees={employees}
                            absences={absences}
                            onAdd={() => { setEditingEmployee(null); setShowModal(true); }}
                            onEdit={(emp) => { setEditingEmployee(emp); setShowModal(true); }}
                            onDelete={deleteEmployee}
                        />
                    )}

                    {activeTab === 'modifications' && (
                        <ModificationsTab
                            employees={employees}
                            absences={absences}
                            setAbsences={setAbsences}
                            retards={retards}
                            setRetards={setRetards}
                            heuresSupp={heuresSupp}
                            setHeuresSupp={setHeuresSupp}
                            setMessage={setMessage}
                        />
                    )}

                    {activeTab === 'chantiers' && (
                        <ChantiersTab
                            chantiers={chantiers}
                            employees={employees}
                            onAdd={() => { setEditingChantier(null); setShowChantierModal(true); }}
                            onEdit={(ch) => { setEditingChantier(ch); setShowChantierModal(true); }}
                            onDelete={deleteChantier}
                            setChantiers={setChantiers}
                            setMessage={setMessage}
                        />
                    )}

                    {activeTab === 'export' && (
                        <ExportTab employees={employees} onExport={exportEmployee} />
                    )}

                    {showModal && (
                        <EmployeeModal
                            employee={editingEmployee}
                            onSave={saveEmployee}
                            onClose={() => { setShowModal(false); setEditingEmployee(null); }}
                        />
                    )}

                    {showChantierModal && (
                        <ChantierModal
                            chantier={editingChantier}
                            employees={employees}
                            onSave={saveChantier}
                            onClose={() => { setShowChantierModal(false); setEditingChantier(null); }}
                        />
                    )}

                    {showPasswordModal && (
                        <PasswordModal
                            onSave={changePassword}
                            onClose={() => setShowPasswordModal(false)}
                        />
                    )}
                </div>
            );
        }

        // â”€â”€â”€ LOGIN â”€â”€â”€
        function LoginForm({ onLogin, message }) {
            return (
                <div className="login-page">
                    <div className="login-container">
                        <div className="login-logo-wrap">
                            <img className="login-logo" src="logo2.png" />
                        </div>
                        <h2>Connexion</h2>
                        <p>AccÃ©dez Ã  la gestion du personnel</p>
                        {message && message.type === 'error' && <div className="error-message">{message.text}</div>}
                        <form onSubmit={onLogin}>
                            <div className="input-group">
                                <label>Nom d'utilisateur</label>
                                <input type="text" name="username" required />
                            </div>
                            <div className="input-group">
                                <label>Mot de passe</label>
                                <input type="password" name="password" required />
                            </div>
                            <button type="submit" className="primary-btn">Se connecter</button>
                        </form>
                    </div>
                </div>
            );
        }

        // â”€â”€â”€ PASSWORD MODAL â”€â”€â”€
        function PasswordModal({ onSave, onClose }) {
            const [oldPwd, setOldPwd] = useState('');
            const [newPwd, setNewPwd] = useState('');
            const [confirmPwd, setConfirmPwd] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (newPwd !== confirmPwd) { setError('Les mots de passe ne correspondent pas'); return; }
                if (newPwd.length < 3) { setError('Le mot de passe doit avoir au moins 3 caractÃ¨res'); return; }
                setError('');
                onSave(oldPwd, newPwd);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal" style={{ maxWidth: '440px' }}>
                        <h3>ðŸ” Modifier le mot de passe</h3>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Ancien mot de passe</label>
                                <input type="password" value={oldPwd} onChange={e => setOldPwd(e.target.value)} required />
                            </div>
                            <div className="form-group">
                                <label>Nouveau mot de passe</label>
                                <input type="password" value={newPwd} onChange={e => setNewPwd(e.target.value)} required />
                            </div>
                            <div className="form-group">
                                <label>Confirmer le nouveau mot de passe</label>
                                <input type="password" value={confirmPwd} onChange={e => setConfirmPwd(e.target.value)} required />
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Annuler</button>
                                <button type="submit" className="btn btn-edit">Changer</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // â”€â”€â”€ DASHBOARD â”€â”€â”€
        function Dashboard({ stats, activeChantiers, employees }) {
            const today = new Date().toISOString().split('T')[0];

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card present">
                            <h4>PrÃ©sents</h4>
                            <div className="value">{stats.present}</div>
                        </div>
                        <div className="stat-card late">
                            <h4>Retards aujourd'hui</h4>
                            <div className="value">{stats.late}</div>
                            <div className="list">{stats.lateEmployees.length > 0 ? stats.lateEmployees.join(', ') : 'Aucun retard'}</div>
                        </div>
                        <div className="stat-card absent">
                            <h4>Absents</h4>
                            <div className="value">{stats.absent}</div>
                            <div className="list">{stats.absentEmployees.length > 0 ? stats.absentEmployees.join(', ') : 'Aucune absence'}</div>
                        </div>
                    </div>

                    <div className="chantiers-dashboard">
                        <h3>ðŸ—ï¸ Chantiers en cours aujourd'hui</h3>
                        {activeChantiers.length === 0 ? (
                            <p style={{ textAlign: 'center', color: 'var(--text-light)', padding: '36px 0', fontSize: '14px' }}>
                                Aucun chantier actif aujourd'hui
                            </p>
                        ) : (
                            activeChantiers.map(chantier => {
                                const assignedToday = (chantier.employees || []).filter(assignment => {
                                    const start = new Date(assignment.dateDebut + 'T00:00:00');
                                    const end = new Date(assignment.dateFin + 'T00:00:00');
                                    const todayDate = new Date(today + 'T00:00:00');
                                    return todayDate >= start && todayDate <= end;
                                });

                                return (
                                    <div key={chantier.id} className="chantier-dashboard-item">
                                        <div className="chantier-dashboard-header">
                                            <div>
                                                <div className="chantier-dashboard-title">{chantier.nom}</div>
                                                <div className="chantier-dashboard-lieu">ðŸ“ {chantier.lieu}</div>
                                                <div className="chantier-dashboard-dates">
                                                    Du {new Date(chantier.dateDebut + 'T00:00:00').toLocaleDateString('fr-FR')}
                                                    au {new Date(chantier.dateFin + 'T00:00:00').toLocaleDateString('fr-FR')}
                                                </div>
                                            </div>
                                            <div className="chantier-dashboard-zone-badge">
                                                Zone {chantier.zone} â€¢ {chantier.panier}â‚¬
                                            </div>
                                        </div>

                                        {assignedToday.length > 0 && (
                                            <div>
                                                <div style={{
                                                    fontSize: '12px',
                                                    fontWeight: '600',
                                                    color: 'var(--text-light)',
                                                    marginBottom: '10px',
                                                    textTransform: 'uppercase',
                                                    letterSpacing: '0.5px'
                                                }}>
                                                    EmployÃ©s assignÃ©s ({assignedToday.length})
                                                </div>
                                                <div className="chantier-employees-list">
                                                    {assignedToday.map(assignment => {
                                                        const emp = employees.find(e => e.id === assignment.employeeId);
                                                        return emp ? (
                                                            <div key={assignment.id} className="chantier-employee-badge">
                                                                {emp.nom}
                                                            </div>
                                                        ) : null;
                                                    })}
                                                </div>
                                            </div>
                                        )}

                                        {assignedToday.length === 0 && (
                                            <div style={{
                                                fontSize: '13px',
                                                color: 'var(--text-light)',
                                                fontStyle: 'italic',
                                                marginTop: '10px'
                                            }}>
                                                Aucun employÃ© assignÃ© aujourd'hui
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        }

        // â”€â”€â”€ EMPLOYEES TAB â”€â”€â”€
        function EmployeesTab({ employees, absences, onAdd, onEdit, onDelete }) {
            const [selectedEmp, setSelectedEmp] = useState(null);
            const [detailTab, setDetailTab] = useState('absences');
            const empAbsences = selectedEmp ? absences.filter(a => a.employeeId === selectedEmp.id) : [];
            const cpBal = selectedEmp ? computeCPBalance(selectedEmp, absences) : null;

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '18px' }}>
                            <h3>Gestion des EmployÃ©s</h3>
                            <button className="btn btn-edit" onClick={onAdd}>+ Ajouter</button>
                        </div>
                        <div className="employee-list">
                            {employees.length === 0 ? (
                                <p style={{ textAlign: 'center', color: 'var(--text-light)', padding: '36px' }}>Aucun employÃ© enregistrÃ©</p>
                            ) : employees.map(emp => (
                                <div key={emp.id} className="employee-item" style={selectedEmp?.id === emp.id ? { border: '2px solid var(--secondary)', background: '#fdf2f8' } : {}}>
                                    <div className="employee-info" style={{ cursor: 'pointer' }} onClick={() => setSelectedEmp(selectedEmp?.id === emp.id ? null : emp)}>
                                        <h4>{emp.nom}</h4>
                                        <p>Cliquez pour voir les dÃ©tails</p>
                                    </div>
                                    <div className="employee-actions">
                                        <button className="btn btn-edit" onClick={() => onEdit(emp)}>Modifier</button>
                                        <button className="btn btn-delete" onClick={() => onDelete(emp.id)}>Supprimer</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {selectedEmp && (
                        <div className="detail-panel">
                            <div className="detail-panel-header">
                                <h4>ðŸ“‹ DÃ©tails â€“ {selectedEmp.nom}</h4>
                                <button style={{ background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white', cursor: 'pointer', fontSize: '18px', borderRadius: '6px', padding: '2px 8px' }} onClick={() => setSelectedEmp(null)}>Ã—</button>
                            </div>
                            <div className="detail-panel-body">
                                {cpBal && (
                                    <div className="cp-summary">
                                        <div className="cp-card">
                                            <div className="cp-label">CP de base (annÃ©e)</div>
                                            <div className="cp-value">{cpBal.base}</div>
                                        </div>
                                        <div className="cp-card">
                                            <div className="cp-label">AccumulÃ©s (+2.5/mois)</div>
                                            <div className="cp-value" style={{ color: 'var(--success)' }}>+{cpBal.accumulated}</div>
                                        </div>
                                        <div className="cp-card">
                                            <div className="cp-label">UtilisÃ©s</div>
                                            <div className="cp-value warning">{cpBal.used}</div>
                                        </div>
                                        <div className="cp-card">
                                            <div className="cp-label">Solde CP</div>
                                            <div className={`cp-value ${cpBal.balance < 0 ? 'danger' : ''}`}>{cpBal.balance}</div>
                                        </div>
                                    </div>
                                )}

                                <div className="detail-tabs" style={{ marginTop: '18px' }}>
                                    <button className={`detail-tab ${detailTab === 'absences' ? 'active' : ''}`} onClick={() => setDetailTab('absences')}>Absences</button>
                                    <button className={`detail-tab ${detailTab === 'horaires' ? 'active' : ''}`} onClick={() => setDetailTab('horaires')}>Horaires</button>
                                </div>

                                {detailTab === 'absences' && (
                                    <div>
                                        {empAbsences.length === 0 ? (
                                            <p style={{ color: 'var(--text-light)', fontSize: '13px', padding: '12px 0' }}>Aucune absence enregistrÃ©e</p>
                                        ) : empAbsences.map(abs => {
                                            const motifClass = abs.motif === 'CongÃ©s payÃ©s' ? 'motif-cp' : abs.motif === 'Maladie' ? 'motif-maladie' : 'motif-other';
                                            return (
                                                <div key={abs.id} className="absence-list-item">
                                                    <div>
                                                        <span style={{ fontSize: '13px', fontWeight: '600', color: 'var(--text-dark)' }}>
                                                            {new Date(abs.dateDebut + 'T00:00:00').toLocaleDateString('fr-FR')} â†’ {new Date(abs.dateFin + 'T00:00:00').toLocaleDateString('fr-FR')}
                                                        </span>
                                                        <span style={{ fontSize: '11px', color: 'var(--text-light)', marginLeft: '10px' }}>
                                                            ({countWorkDays(abs.dateDebut, abs.dateFin)} jour{countWorkDays(abs.dateDebut, abs.dateFin) > 1 ? 's' : ''})
                                                        </span>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                        <span className={`motif-tag ${motifClass}`}>{abs.motif}</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {detailTab === 'horaires' && (
                                    <div style={{ display: 'grid', gap: '6px' }}>
                                        {['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'].map(jour => {
                                            const h = selectedEmp.horaires?.[jour];
                                            const hasHoraires = h?.debut && h?.fin;
                                            return (
                                                <div key={jour} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 12px', background: 'var(--bg-light)', borderRadius: '8px' }}>
                                                    <span style={{ fontWeight: '600', fontSize: '13px', textTransform: 'capitalize', color: 'var(--text-dark)', minWidth: '90px' }}>{jour}</span>
                                                    {hasHoraires ? (
                                                        <span style={{ fontSize: '13px', color: 'var(--primary)', fontWeight: '600' }}>{h.debut} â€“ {h.fin}</span>
                                                    ) : (
                                                        <span style={{ fontSize: '12px', color: 'var(--text-light)', fontStyle: 'italic' }}>Repos</span>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // â”€â”€â”€ EMPLOYEE MODAL â”€â”€â”€
        function EmployeeModal({ employee, onSave, onClose }) {
            const [formData, setFormData] = useState(employee || {
                nom: '',
                cpBase: 25,
                horaires: {
                    lundi: { debut: '', fin: '' },
                    mardi: { debut: '', fin: '' },
                    mercredi: { debut: '', fin: '' },
                    jeudi: { debut: '', fin: '' },
                    vendredi: { debut: '', fin: '' },
                    samedi: { debut: '', fin: '' },
                    dimanche: { debut: '', fin: '' }
                }
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            const updateHoraire = (jour, type, value) => {
                setFormData({
                    ...formData,
                    horaires: {
                        ...formData.horaires,
                        [jour]: { ...formData.horaires[jour], [type]: value }
                    }
                });
            };

            const jours = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h3>{employee ? "Modifier l'employÃ©" : 'Nouvel employÃ©'}</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Nom complet</label>
                                <input type="text" value={formData.nom} onChange={e => setFormData({ ...formData, nom: e.target.value })} required />
                            </div>
                            <div className="form-group">
                                <label>Nombre de CP de base (jours/an)</label>
                                <input
                                    type="number"
                                    value={formData.cpBase || 25}
                                    min="0"
                                    max="50"
                                    step="0.5"
                                    onChange={e => setFormData({ ...formData, cpBase: parseFloat(e.target.value) || 0 })}
                                />
                            </div>
                            <h4 style={{ marginTop: '20px', marginBottom: '12px', color: 'var(--primary)', fontSize: '14px' }}>Horaires hebdomadaires</h4>
                            <div className="schedule-grid">
                                {jours.map(jour => (
                                    <div key={jour} className="schedule-day">
                                        <label style={{ textTransform: 'capitalize' }}>{jour}</label>
                                        <div className="time-inputs">
                                            <input
                                                type="time"
                                                value={formData.horaires[jour]?.debut || ''}
                                                onChange={e => updateHoraire(jour, 'debut', e.target.value)}
                                            />
                                        </div>
                                        <div className="time-inputs">
                                            <input
                                                type="time"
                                                value={formData.horaires[jour]?.fin || ''}
                                                onChange={e => updateHoraire(jour, 'fin', e.target.value)}
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Annuler</button>
                                <button type="submit" className="btn btn-edit">Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // â”€â”€â”€ MODIFICATIONS TAB â”€â”€â”€
        function ModificationsTab({ employees, absences, setAbsences, retards, setRetards, heuresSupp, setHeuresSupp, setMessage }) {
            const [selectedEmp, setSelectedEmp] = useState('');
            const [absenceForm, setAbsenceForm] = useState({ employeeId: '', dateDebut: '', dateFin: '', motif: 'CongÃ©s payÃ©s' });
            const [retardForm, setRetardForm] = useState({ employeeId: '', date: '', minutes: 0 });
            const [heureSuppForm, setHeureSuppForm] = useState({ employeeId: '', date: '', type: 'arrivee', heureReelle: '' });

            const motifsAbsence = ['CongÃ©s payÃ©s', 'Maladie', 'CongÃ© sans solde', 'Formation', 'Ã‰vÃ©nement familial', 'Autre'];

            const empAbsences = selectedEmp ? absences.filter(a => a.employeeId === selectedEmp) : [];
            const empRetards = selectedEmp ? retards.filter(r => r.employeeId === selectedEmp) : [];
            const empHeuresSupp = selectedEmp ? heuresSupp.filter(h => h.employeeId === selectedEmp) : [];

            const handleAbsenceSubmit = (e) => {
                e.preventDefault();
                const form = { ...absenceForm, employeeId: selectedEmp };
                if (!form.employeeId || !form.dateDebut || !form.dateFin) return;
                setAbsences([...absences, { id: Date.now().toString(), ...form }]);
                setAbsenceForm({ employeeId: '', dateDebut: '', dateFin: '', motif: 'CongÃ©s payÃ©s' });
                setMessage({ type: 'success', text: 'Absence enregistrÃ©e' });
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteAbsence = (id) => {
                setAbsences(absences.filter(a => a.id !== id));
                setMessage({ type: 'success', text: 'Absence supprimÃ©e' });
                setTimeout(() => setMessage(null), 3000);
            };

            const handleRetardSubmit = (e) => {
                e.preventDefault();
                const form = { ...retardForm, employeeId: selectedEmp };
                if (!form.employeeId || !form.date || !form.minutes) return;
                setRetards([...retards, { id: Date.now().toString(), ...form, minutes: parseInt(form.minutes) }]);
                setRetardForm({ employeeId: '', date: '', minutes: 0 });
                setMessage({ type: 'success', text: 'Retard enregistrÃ©' });
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteRetard = (id) => {
                setRetards(retards.filter(r => r.id !== id));
                setMessage({ type: 'success', text: 'Retard supprimÃ©' });
                setTimeout(() => setMessage(null), 3000);
            };

            const handleHeureSuppSubmit = (e) => {
                e.preventDefault();
                const form = { ...heureSuppForm, employeeId: selectedEmp };
                if (!form.employeeId || !form.date || !form.heureReelle) return;
                setHeuresSupp([...heuresSupp, { id: Date.now().toString(), ...form }]);
                setHeureSuppForm({ employeeId: '', date: '', type: 'arrivee', heureReelle: '' });
                setMessage({ type: 'success', text: 'Heures supplÃ©mentaires enregistrÃ©es' });
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteHeureSupp = (id) => {
                setHeuresSupp(heuresSupp.filter(h => h.id !== id));
                setMessage({ type: 'success', text: 'Heures supplÃ©mentaires supprimÃ©es' });
                setTimeout(() => setMessage(null), 3000);
            };

            const empName = selectedEmp ? employees.find(e => e.id === selectedEmp)?.nom : '';

            return (
                <div>
                    <div className="card">
                        <h3>SÃ©lectionner un employÃ©</h3>
                        <div className="form-group" style={{ marginBottom: 0 }}>
                            <select value={selectedEmp} onChange={e => setSelectedEmp(e.target.value)} style={{ maxWidth: '320px' }}>
                                <option value="">Choisir un employÃ©...</option>
                                {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.nom}</option>)}
                            </select>
                        </div>
                    </div>

                    {selectedEmp && (
                        <>
                            <div className="card">
                                <h3>Absences â€“ {empName}</h3>
                                <form onSubmit={handleAbsenceSubmit}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date de dÃ©but</label>
                                            <input type="date" value={absenceForm.dateDebut} onChange={e => setAbsenceForm({ ...absenceForm, dateDebut: e.target.value })} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Date de fin</label>
                                            <input type="date" value={absenceForm.dateFin} onChange={e => setAbsenceForm({ ...absenceForm, dateFin: e.target.value })} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Motif</label>
                                            <select value={absenceForm.motif} onChange={e => setAbsenceForm({ ...absenceForm, motif: e.target.value })} required>
                                                {motifsAbsence.map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" className="btn btn-edit">+ Ajouter absence</button>
                                </form>

                                {empAbsences.length > 0 && (
                                    <div style={{ marginTop: '16px' }}>
                                        <p style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-light)', textTransform: 'uppercase', marginBottom: '8px' }}>Liste des absences</p>
                                        {empAbsences.map(abs => {
                                            const motifClass = abs.motif === 'CongÃ©s payÃ©s' ? 'motif-cp' : abs.motif === 'Maladie' ? 'motif-maladie' : 'motif-other';
                                            return (
                                                <div key={abs.id} className="absence-list-item">
                                                    <div>
                                                        <span style={{ fontSize: '13px', fontWeight: '600' }}>
                                                            {new Date(abs.dateDebut + 'T00:00:00').toLocaleDateString('fr-FR')} â†’ {new Date(abs.dateFin + 'T00:00:00').toLocaleDateString('fr-FR')}
                                                        </span>
                                                        <span style={{ fontSize: '11px', color: 'var(--text-light)', marginLeft: '8px' }}>
                                                            ({countWorkDays(abs.dateDebut, abs.dateFin)} jour{countWorkDays(abs.dateDebut, abs.dateFin) > 1 ? 's' : ''})
                                                        </span>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                        <span className={`motif-tag ${motifClass}`}>{abs.motif}</span>
                                                        <button className="btn btn-delete" style={{ padding: '4px 10px', fontSize: '11px' }} onClick={() => deleteAbsence(abs.id)}>Supprimer</button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            <div className="card">
                                <h3>Retards & DÃ©parts anticipÃ©s â€“ {empName}</h3>
                                <form onSubmit={handleRetardSubmit}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date</label>
                                            <input type="date" value={retardForm.date} onChange={e => setRetardForm({ ...retardForm, date: e.target.value })} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Minutes (+ retard / âˆ’ dÃ©part tÃ´t)</label>
                                            <input type="number" value={retardForm.minutes} onChange={e => setRetardForm({ ...retardForm, minutes: e.target.value })} required />
                                        </div>
                                    </div>
                                    <button type="submit" className="btn btn-edit">+ Ajouter retard</button>
                                </form>

                                {empRetards.length > 0 && (
                                    <div style={{ marginTop: '16px' }}>
                                        <p style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-light)', textTransform: 'uppercase', marginBottom: '8px' }}>Liste des retards</p>
                                        {empRetards.map(ret => (
                                            <div key={ret.id} className="absence-list-item">
                                                <span style={{ fontSize: '13px', fontWeight: '600' }}>
                                                    {new Date(ret.date + 'T00:00:00').toLocaleDateString('fr-FR')} â€“ {ret.minutes > 0 ? `+${ret.minutes} min` : `${ret.minutes} min`}
                                                </span>
                                                <button className="btn btn-delete" style={{ padding: '4px 10px', fontSize: '11px' }} onClick={() => deleteRetard(ret.id)}>Supprimer</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="card">
                                <h3>Heures SupplÃ©mentaires â€“ {empName}</h3>
                                <form onSubmit={handleHeureSuppSubmit}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date</label>
                                            <input type="date" value={heureSuppForm.date} onChange={e => setHeureSuppForm({ ...heureSuppForm, date: e.target.value })} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Type</label>
                                            <select value={heureSuppForm.type} onChange={e => setHeureSuppForm({ ...heureSuppForm, type: e.target.value })}>
                                                <option value="arrivee">ArrivÃ©e anticipÃ©e</option>
                                                <option value="depart">DÃ©part tardif</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Heure rÃ©elle</label>
                                            <input type="time" value={heureSuppForm.heureReelle} onChange={e => setHeureSuppForm({ ...heureSuppForm, heureReelle: e.target.value })} required />
                                        </div>
                                    </div>
                                    <button type="submit" className="btn btn-edit">+ Ajouter</button>
                                </form>

                                {empHeuresSupp.length > 0 && (
                                    <div style={{ marginTop: '16px' }}>
                                        <p style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-light)', textTransform: 'uppercase', marginBottom: '8px' }}>Liste des heures supplÃ©mentaires</p>
                                        {empHeuresSupp.map(hs => (
                                            <div key={hs.id} className="absence-list-item">
                                                <span style={{ fontSize: '13px', fontWeight: '600' }}>
                                                    {new Date(hs.date + 'T00:00:00').toLocaleDateString('fr-FR')} â€“ {hs.type === 'arrivee' ? 'ArrivÃ©e' : 'DÃ©part'} Ã  {hs.heureReelle}
                                                </span>
                                                <button className="btn btn-delete" style={{ padding: '4px 10px', fontSize: '11px' }} onClick={() => deleteHeureSupp(hs.id)}>Supprimer</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // â”€â”€â”€ CHANTIERS TAB â”€â”€â”€
        function ChantiersTab({ chantiers, employees, onAdd, onEdit, onDelete, setChantiers, setMessage }) {
            const [showAssignModal, setShowAssignModal] = useState(false);
            const [selectedChantier, setSelectedChantier] = useState(null);
            const [assignForm, setAssignForm] = useState({ employeeId: '', dateDebut: '', dateFin: '' });

            const handleAssignEmployee = (chantier) => {
                setSelectedChantier(chantier);
                setShowAssignModal(true);
                setAssignForm({ employeeId: '', dateDebut: '', dateFin: '' });
            };

            const submitAssignment = (e) => {
                e.preventDefault();
                if (!assignForm.employeeId || !assignForm.dateDebut || !assignForm.dateFin) return;
                setChantiers(chantiers.map(c => c.id === selectedChantier.id ? {
                    ...c,
                    employees: [...(c.employees || []), { id: Date.now().toString(), ...assignForm }]
                } : c));
                setShowAssignModal(false);
                setSelectedChantier(null);
                setMessage({ type: 'success', text: 'EmployÃ© assignÃ© au chantier' });
                setTimeout(() => setMessage(null), 3000);
            };

            const removeAssignment = (chantierId, assignmentId) => {
                if (confirm('Retirer cet employÃ© ?')) {
                    setChantiers(chantiers.map(c => c.id === chantierId ? {
                        ...c,
                        employees: c.employees.filter(e => e.id !== assignmentId)
                    } : c));
                    setMessage({ type: 'success', text: 'Assignation supprimÃ©e' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            return (
                <div className="card">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '18px' }}>
                        <h3>Gestion des Chantiers</h3>
                        <button className="btn btn-edit" onClick={onAdd}>+ Nouveau chantier</button>
                    </div>

                    {chantiers.length === 0 ? (
                        <p style={{ textAlign: 'center', color: 'var(--text-light)', padding: '36px' }}>Aucun chantier enregistrÃ©</p>
                    ) : chantiers.map(chantier => (
                        <div key={chantier.id} className="chantier-item">
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '10px' }}>
                                <div>
                                    <h4>{chantier.nom}</h4>
                                    <p>{chantier.lieu}</p>
                                    <p>Du {new Date(chantier.dateDebut + 'T00:00:00').toLocaleDateString('fr-FR')} au {new Date(chantier.dateFin + 'T00:00:00').toLocaleDateString('fr-FR')}</p>
                                    <span className="badge badge-zone">Zone {chantier.zone} â€“ Panier: {chantier.panier}â‚¬</span>
                                </div>
                                <div style={{ display: 'flex', gap: '6px' }}>
                                    <button className="btn btn-secondary" onClick={() => handleAssignEmployee(chantier)}>Assigner</button>
                                    <button className="btn btn-edit" onClick={() => onEdit(chantier)}>Modifier</button>
                                    <button className="btn btn-delete" onClick={() => onDelete(chantier.id)}>Supprimer</button>
                                </div>
                            </div>

                            {chantier.employees && chantier.employees.length > 0 && (
                                <div className="employee-assignments">
                                    <h4 style={{ fontSize: '13px', marginBottom: '10px', color: 'var(--primary)' }}>EmployÃ©s assignÃ©s :</h4>
                                    {chantier.employees.map(assignment => {
                                        const emp = employees.find(e => e.id === assignment.employeeId);
                                        return emp ? (
                                            <div key={assignment.id} className="assignment-item">
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                    <div>
                                                        <strong style={{ fontSize: '13px' }}>{emp.nom}</strong>
                                                        <p style={{ fontSize: '12px', color: 'var(--text-light)', margin: '3px 0 0 0' }}>
                                                            Du {new Date(assignment.dateDebut + 'T00:00:00').toLocaleDateString('fr-FR')} au {new Date(assignment.dateFin + 'T00:00:00').toLocaleDateString('fr-FR')}
                                                        </p>
                                                    </div>
                                                    <button className="btn btn-delete" style={{ padding: '5px 10px', fontSize: '11px' }} onClick={() => removeAssignment(chantier.id, assignment.id)}>Retirer</button>
                                                </div>
                                            </div>
                                        ) : null;
                                    })}
                                </div>
                            )}
                        </div>
                    ))}

                    {showAssignModal && (
                        <div className="modal-overlay">
                            <div className="modal">
                                <h3>Assigner un employÃ©</h3>
                                <p style={{ color: 'var(--text-light)', marginBottom: '18px', fontSize: '13px' }}>Chantier : {selectedChantier.nom}</p>
                                <form onSubmit={submitAssignment}>
                                    <div className="form-group">
                                        <label>EmployÃ©</label>
                                        <select value={assignForm.employeeId} onChange={e => setAssignForm({ ...assignForm, employeeId: e.target.value })} required>
                                            <option value="">SÃ©lectionner...</option>
                                            {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.nom}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date de dÃ©but</label>
                                            <input
                                                type="date"
                                                value={assignForm.dateDebut}
                                                onChange={e => setAssignForm({ ...assignForm, dateDebut: e.target.value })}
                                                min={selectedChantier.dateDebut}
                                                max={selectedChantier.dateFin}
                                                required
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Date de fin</label>
                                            <input
                                                type="date"
                                                value={assignForm.dateFin}
                                                onChange={e => setAssignForm({ ...assignForm, dateFin: e.target.value })}
                                                min={selectedChantier.dateDebut}
                                                max={selectedChantier.dateFin}
                                                required
                                            />
                                        </div>
                                    </div>
                                    <div className="modal-actions">
                                        <button type="button" className="btn btn-secondary" onClick={() => { setShowAssignModal(false); setSelectedChantier(null); }}>Annuler</button>
                                        <button type="submit" className="btn btn-edit">Assigner</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // â”€â”€â”€ CHANTIER MODAL â”€â”€â”€
        function ChantierModal({ chantier, employees, onSave, onClose }) {
            const [formData, setFormData] = useState(chantier || { nom: '', lieu: '', dateDebut: '', dateFin: '', employees: [] });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h3>{chantier ? 'Modifier le chantier' : 'Nouveau chantier'}</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Nom du chantier</label>
                                <input type="text" value={formData.nom} onChange={e => setFormData({ ...formData, nom: e.target.value })} required />
                            </div>
                            <div className="form-group">
                                <label>Lieu de travail (adresse complÃ¨te)</label>
                                <textarea value={formData.lieu} onChange={e => setFormData({ ...formData, lieu: e.target.value })} rows="3" required placeholder="Ex: 123 Rue de la Paix, 59000 Lille" />
                            </div>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>Date de dÃ©but</label>
                                    <input type="date" value={formData.dateDebut} onChange={e => setFormData({ ...formData, dateDebut: e.target.value })} required />
                                </div>
                                <div className="form-group">
                                    <label>Date de fin</label>
                                    <input type="date" value={formData.dateFin} onChange={e => setFormData({ ...formData, dateFin: e.target.value })} required />
                                </div>
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Annuler</button>
                                <button type="submit" className="btn btn-edit">Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // â”€â”€â”€ EXPORT TAB â”€â”€â”€
        function ExportTab({ employees, onExport }) {
            const [selectedEmployee, setSelectedEmployee] = useState('');

            return (
                <div className="card">
                    <h3>Exporter les plannings</h3>
                    <div className="export-section">
                        <h4>SÃ©lectionner un employÃ©</h4>
                        <p style={{ color: 'var(--text-light)', marginBottom: '14px', fontSize: '13px' }}>
                            Le planning annuel sera exportÃ© au format Excel colorÃ© avec un onglet par mois et un rÃ©sumÃ© CP
                        </p>
                        <div className="form-grid">
                            <div className="form-group">
                                <label>EmployÃ©</label>
                                <select value={selectedEmployee} onChange={e => setSelectedEmployee(e.target.value)}>
                                    <option value="">SÃ©lectionner...</option>
                                    {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.nom}</option>)}
                                </select>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                                <button
                                    className="btn btn-edit"
                                    onClick={() => selectedEmployee && onExport(selectedEmployee)}
                                    disabled={!selectedEmployee}
                                    style={{ width: '100%' }}
                                >
                                    ðŸ“¥ Exporter le planning
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
