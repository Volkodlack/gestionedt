<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thierry Carles - Gestion du Personnel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3d3573;
            --secondary: #e84597;
            --accent: #c1439d;
            --bg-dark: #1a1633;
            --bg-light: #f8f7fc;
            --text-dark: #2a2547;
            --text-light: #6b6885;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e8e6f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #fff 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #2d2558 100%);
            padding: 24px 32px;
            border-radius: 20px;
            margin-bottom: 28px;
            box-shadow: 0 20px 60px rgba(61, 53, 115, 0.25);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%; right: -10%;
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(232, 69, 151, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }
        .header-left { display: flex; align-items: center; gap: 16px; position: relative; z-index: 1; }
        .header-logo { height: 48px; }
        .header-title { color: white; font-family: 'Manrope', sans-serif; }
        .header-title h1 { font-size: 24px; font-weight: 800; margin-bottom: 2px; }
        .header-title p { font-size: 13px; opacity: 0.8; font-weight: 400; }
        .header-actions { display: flex; gap: 8px; align-items: center; position: relative; z-index: 1; flex-wrap: wrap; justify-content: flex-end; }

        .logout-btn {
            background: rgba(255,255,255,0.15); color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 9px 16px; border-radius: 10px;
            cursor: pointer; font-weight: 600; font-size: 13px;
            transition: all 0.3s ease; backdrop-filter: blur(10px);
        }
        .logout-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }
        .unsaved-badge {
            background: rgba(255,193,7,0.2); color: #fff;
            padding: 7px 12px; border-radius: 8px; font-size: 12px;
            font-weight: 600; border: 1px solid rgba(255,193,7,0.3);
        }

        /* ===== LOGIN ===== */
        .login-page {
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1a1633 0%, #2d2558 50%, #3d3573 100%);
            position: relative; overflow: hidden;
        }
        .login-page::before {
            content: ''; position: absolute;
            top: -30%; left: -20%; width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(232,69,151,0.12) 0%, transparent 70%);
            border-radius: 50%;
        }
        .login-page::after {
            content: ''; position: absolute;
            bottom: -25%; right: -15%; width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(61,53,115,0.3) 0%, transparent 70%);
            border-radius: 50%;
        }
        .login-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 48px 42px 42px; border-radius: 28px;
            max-width: 420px; width: 90%;
            box-shadow: 0 30px 80px rgba(0,0,0,0.2);
            position: relative; z-index: 1;
        }
        .login-logo-wrap { text-align: center; margin-bottom: 28px; }
        .login-logo { height: 70px; }
        .login-container h2 {
            color: var(--primary); margin-bottom: 6px;
            font-size: 26px; font-weight: 800;
            font-family: 'Manrope', sans-serif; text-align: center;
        }
        .login-container > p {
            color: var(--text-light); margin-bottom: 28px;
            font-size: 14px; text-align: center;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 7px; color: var(--text-dark); font-weight: 600; font-size: 13px; }
        .input-group input {
            width: 100%; padding: 13px 15px;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 14px; transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .input-group input:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 4px rgba(232,69,151,0.1); }

        .primary-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white; border: none; padding: 14px; border-radius: 12px;
            font-weight: 700; font-size: 15px; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(232,69,151,0.3);
        }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(232,69,151,0.4); }

        /* ===== TABS ===== */
        .tabs {
            display: flex; gap: 8px; margin-bottom: 24px;
            background: white; padding: 6px;
            border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .tab {
            flex: 1; padding: 12px 16px;
            background: transparent; border: none; border-radius: 12px;
            cursor: pointer; font-weight: 600; font-size: 14px;
            color: var(--text-light); transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .tab.active {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
            color: white; box-shadow: 0 4px 12px rgba(232,69,151,0.3);
        }
        .tab:hover:not(.active) { background: var(--bg-light); }

        /* ===== CARDS ===== */
        .card { background: white; padding: 28px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .card h3 { color: var(--primary); margin-bottom: 18px; font-size: 20px; font-weight: 700; font-family: 'Manrope', sans-serif; }

        /* ===== STATS ===== */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: white; padding: 24px; border-radius: 18px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            border-left: 4px solid var(--primary); transition: all 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .stat-card.present { border-left-color: var(--success); }
        .stat-card.late { border-left-color: var(--warning); }
        .stat-card.absent { border-left-color: var(--danger); }
        .stat-card h4 { color: var(--text-light); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .stat-card .value { font-size: 38px; font-weight: 800; color: var(--text-dark); font-family: 'Manrope', sans-serif; margin-bottom: 6px; }
        .stat-card .list { color: var(--text-light); font-size: 13px; max-height: 80px; overflow-y: auto; }

        /* ===== EMPLOYEES ===== */
        .employee-list { display: grid; gap: 12px; }
        .employee-item {
            background: var(--bg-light); padding: 16px 20px; border-radius: 14px;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.3s ease;
        }
        .employee-item:hover { background: #f0eef8; transform: translateX(3px); }
        .employee-info h4 { color: var(--text-dark); margin-bottom: 4px; font-weight: 600; font-size: 15px; }
        .employee-info p { color: var(--text-light); font-size: 12px; }
        .employee-actions { display: flex; gap: 6px; }

        /* ===== BUTTONS ===== */
        .btn { padding: 9px 16px; border: none; border-radius: 9px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; font-family: 'Plus Jakarta Sans', sans-serif; }
        .btn-edit { background: var(--primary); color: white; }
        .btn-edit:hover { background: #2d2558; transform: translateY(-1px); }
        .btn-delete { background: var(--danger); color: white; }
        .btn-delete:hover { background: #dc2626; transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-light); color: var(--text-dark); border: 2px solid var(--border); }
        .btn-secondary:hover { background: #f0eef8; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-1px); }

        /* ===== FORMS ===== */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-dark); font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 11px 13px;
            border: 2px solid var(--border); border-radius: 10px;
            font-size: 13px; transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(232,69,151,0.1);
        }

        /* ===== SCHEDULE ===== */
        .schedule-grid { display: grid; gap: 8px; margin-top: 12px; }
        .schedule-day { display: grid; grid-template-columns: 100px 1fr 1fr; gap: 10px; align-items: center; padding: 10px; background: var(--bg-light); border-radius: 10px; }
        .schedule-day label { font-weight: 600; color: var(--text-dark); font-size: 13px; }
        .time-inputs { display: flex; gap: 6px; align-items: center; }
        .time-inputs input { flex: 1; padding: 7px 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 12px; }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); display: flex;
            align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal {
            background: white; padding: 36px; border-radius: 24px;
            max-width: 620px; width: 92%; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal h3 { color: var(--primary); margin-bottom: 20px; font-size: 22px; font-weight: 700; font-family: 'Manrope', sans-serif; }
        .modal-actions { display: flex; gap: 10px; margin-top: 24px; }
        .modal-actions button { flex: 1; }

        /* ===== CHANTIERS ===== */
        .chantier-item { background: var(--bg-light); padding: 18px; border-radius: 14px; margin-bottom: 14px; border-left: 4px solid var(--primary); }
        .chantier-item h4 { color: var(--text-dark); margin-bottom: 6px; font-weight: 600; font-size: 15px; }
        .chantier-item p { color: var(--text-light); font-size: 13px; margin-bottom: 3px; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; margin-left: 6px; }
        .badge-zone { background: rgba(232,69,151,0.15); color: var(--accent); }

        .employee-assignments { margin-top: 14px; padding: 14px; background: white; border-radius: 10px; border: 2px solid var(--border); }
        .assignment-item { padding: 10px; background: var(--bg-light); border-radius: 8px; margin-bottom: 8px; }
        .assignment-item:last-child { margin-bottom: 0; }

        /* ===== EXPORT ===== */
        .export-section { background: linear-gradient(135deg, var(--bg-light) 0%, white 100%); padding: 20px; border-radius: 16px; border: 2px dashed var(--border); }
        .export-section h4 { color: var(--primary); margin-bottom: 12px; font-weight: 700; font-size: 15px; }

        /* ===== MESSAGES ===== */
        .error-message { background: rgba(239,68,68,0.1); color: var(--danger); padding: 11px 15px; border-radius: 10px; margin-bottom: 14px; font-size: 13px; border-left: 4px solid var(--danger); }
        .success-message { background: rgba(16,185,129,0.1); color: var(--success); padding: 11px 15px; border-radius: 10px; margin-bottom: 14px; font-size: 13px; border-left: 4px solid var(--success); }

        /* ===== CP SUMMARY ===== */
        .cp-summary {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px; margin-top: 16px;
        }
        .cp-card {
            background: linear-gradient(135deg, #f0eef8, white);
            border-radius: 12px; padding: 14px; text-align: center;
            border: 1px solid var(--border);
        }
        .cp-card .cp-label { font-size: 11px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .cp-card .cp-value { font-size: 24px; font-weight: 800; font-family: 'Manrope', sans-serif; color: var(--primary); }
        .cp-card .cp-value.danger { color: var(--danger); }
        .cp-card .cp-value.warning { color: var(--warning); }

        /* ===== EMPLOYEE DETAIL PANEL ===== */
        .detail-panel {
            background: white; border-radius: 16px; border: 2px solid var(--border);
            overflow: hidden; margin-top: 16px;
        }
        .detail-panel-header {
            background: linear-gradient(135deg, var(--primary), #2d2558);
            color: white; padding: 16px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .detail-panel-header h4 { font-size: 15px; font-weight: 700; font-family: 'Manrope', sans-serif; }
        .detail-panel-body { padding: 20px; }
        .detail-tabs { display: flex; gap: 6px; margin-bottom: 16px; }
        .detail-tab { padding: 7px 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; background: var(--bg-light); color: var(--text-light); transition: all 0.2s; font-family: 'Plus Jakarta Sans', sans-serif; }
        .detail-tab.active { background: var(--primary); color: white; }
        .detail-tab:hover:not(.active) { background: #e8e6f0; }

        .absence-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: var(--bg-light); border-radius: 8px; margin-bottom: 6px;
        }
        .absence-list-item .motif-tag {
            padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
        }
        .motif-cp { background: rgba(16,185,129,0.15); color: var(--success); }
        .motif-maladie { background: rgba(239,68,68,0.15); color: var(--danger); }
        .motif-other { background: rgba(245,158,11,0.15); color: var(--warning); }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--text-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 14px; text-align: center; }
            .tabs { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .schedule-day { grid-template-columns: 1fr; }
            .login-container { padding: 36px 28px 32px; }
        }

        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const LOGO_B64 = "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";

        // ─── AUTH STORAGE ───
        const AUTH_KEY = 'tc_auth';
        function getStoredAuth() {
            try {
                const raw = localStorage.getItem(AUTH_KEY);
                return raw ? JSON.parse(raw) : { username: 'admin', password: 'admin' };
            } catch { return { username: 'admin', password: 'admin' }; }
        }
        function setStoredAuth(obj) {
            try { localStorage.setItem(AUTH_KEY, JSON.stringify(obj)); } catch {}
        }

        // ─── DATA STORAGE ───
        const DATA_KEY = 'tc_data';
        function getStoredData() {
            try {
                const raw = localStorage.getItem(DATA_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch { return null; }
        }
        function setStoredData(obj) {
            try { localStorage.setItem(DATA_KEY, JSON.stringify(obj)); } catch {}
        }

        // ─── UTILS ───
        function countWorkDays(startStr, endStr) {
            let count = 0;
            const start = new Date(startStr + 'T00:00:00');
            const end = new Date(endStr + 'T00:00:00');
            for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const dow = d.getDay();
                if (dow !== 0 && dow !== 6) count++;
            }
            return count;
        }

        function getMonthlyCP(absences, employeeId, year, month) {
            // month is 0-indexed
            return absences.filter(a => {
                if (a.employeeId !== employeeId || a.motif !== 'Congés payés') return false;
                const start = new Date(a.dateDebut + 'T00:00:00');
                const end = new Date(a.dateFin + 'T00:00:00');
                // check overlap with month
                const mStart = new Date(year, month, 1);
                const mEnd = new Date(year, month + 1, 0);
                return start <= mEnd && end >= mStart;
            }).reduce((total, a) => {
                const start = new Date(a.dateDebut + 'T00:00:00');
                const end = new Date(a.dateFin + 'T00:00:00');
                const mStart = new Date(year, month, 1);
                const mEnd = new Date(year, month + 1, 0);
                const effStart = start > mStart ? start : mStart;
                const effEnd = end < mEnd ? end : mEnd;
                let days = 0;
                for (let d = new Date(effStart); d <= effEnd; d.setDate(d.getDate()+1)) {
                    const dow = d.getDay();
                    if (dow !== 0 && dow !== 6) days++;
                }
                return total + days;
            }, 0);
        }

        function computeCPBalance(employee, absences) {
            const now = new Date();
            const year = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-indexed
            // Determine employee start month — use first month of current year if not set
            const startMonth = employee.cpStartMonth !== undefined ? employee.cpStartMonth : 0;
            const cpBase = employee.cpBase || 25;
            // Accumulated = 2.5 per month from startMonth up to and including currentMonth
            const monthsElapsed = currentMonth - startMonth + 1;
            const accumulated = Math.max(0, monthsElapsed) * 2.5;
            // Used = sum of CP days in absences for this year
            let used = 0;
            for (let m = 0; m <= 11; m++) {
                used += getMonthlyCP(absences, employee.id, year, m);
            }
            return { base: cpBase, accumulated: parseFloat(accumulated.toFixed(1)), used, balance: parseFloat((cpBase + accumulated - used).toFixed(1)) };
        }

        // ─── GEOLOCATION ───
        const COMPANY_LAT = 50.3333, COMPANY_LON = 3.5833;
        function calculateDistance(lat1,lon1,lat2,lon2){const R=6371;const dLat=(lat2-lat1)*Math.PI/180;const dLon=(lon2-lon1)*Math.PI/180;const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
        function getZone(address){const postalCode=address.match(/\d{5}/)?.[0];if(!postalCode)return{zone:1,panier:0};const lat=50.3+Math.random()*2;const lon=3.5+Math.random()*2;const distance=calculateDistance(COMPANY_LAT,COMPANY_LON,lat,lon);if(distance<10)return{zone:0,panier:0};if(distance<30)return{zone:1,panier:7.5};if(distance<60)return{zone:2,panier:12.5};return{zone:3,panier:17.5};}

        // ─── APP ───
        function App() {
            const [authenticated, setAuthenticated] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [employees, setEmployees] = useState([]);
            const [chantiers, setChantiers] = useState([]);
            const [absences, setAbsences] = useState([]);
            const [retards, setRetards] = useState([]);
            const [heuresSupp, setHeuresSupp] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [showChantierModal, setShowChantierModal] = useState(false);
            const [editingChantier, setEditingChantier] = useState(null);
            const [message, setMessage] = useState(null);
            const [needsSave, setNeedsSave] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);

            // Auto-load from localStorage on mount
            useEffect(() => {
                const saved = getStoredData();
                if (saved) {
                    if (saved.employees) setEmployees(saved.employees);
                    if (saved.chantiers) setChantiers(saved.chantiers);
                    if (saved.absences) setAbsences(saved.absences);
                    if (saved.retards) setRetards(saved.retards);
                    if (saved.heuresSupp) setHeuresSupp(saved.heuresSupp);
                }
            }, []);

            // Auto-save to localStorage whenever data changes
            useEffect(() => {
                const allData = { employees, chantiers, absences, retards, heuresSupp, lastSaved: new Date().toISOString() };
                setStoredData(allData);
                // needsSave tracks if there's unsaved manual export
                if (employees.length > 0 || chantiers.length > 0 || absences.length > 0) {
                    setNeedsSave(true);
                }
            }, [employees, chantiers, absences, retards, heuresSupp]);

            // ─── SAVE / LOAD FILE ───
            const fileHandleRef = React.useRef(null); // persists the chosen file handle across renders

            const getDataBlob = () => {
                const allData = { employees, chantiers, absences, retards, heuresSupp, lastSaved: new Date().toISOString() };
                return new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            };

            // "Enregistrer sous" – opens native Save As dialog (File System Access API)
            const saveDataToFile = async () => {
                try {
                    if (window.showSaveFilePicker) {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: 'thierry-carles-data.json',
                            types: [{
                                description: 'Fichier données JSON',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                        const writable = await handle.createWritable();
                        await writable.write(getDataBlob());
                        await writable.close();
                        fileHandleRef.current = handle; // remember for quick-save
                        setNeedsSave(false);
                        setMessage({ type: 'success', text: `Enregistré : ${handle.name}` });
                        setTimeout(() => setMessage(null), 3000);
                    } else {
                        // Fallback pour les navigateurs qui ne supportent pas showSaveFilePicker
                        const url = URL.createObjectURL(getDataBlob());
                        const link = document.createElement('a');
                        link.href = url; link.download = 'thierry-carles-data.json'; link.click();
                        URL.revokeObjectURL(url);
                        setNeedsSave(false);
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        setMessage({ type: 'error', text: 'Erreur lors de la sauvegarde' });
                        setTimeout(() => setMessage(null), 3000);
                    }
                }
            };

            // "Enregistrer" – écrit directement dans le fichier déjà choisi (pas de dialogue)
            const saveDataQuick = async () => {
                if (!fileHandleRef.current) { return saveDataToFile(); } // rien choisi encore → ouvrir le dialogue
                try {
                    const writable = await fileHandleRef.current.createWritable();
                    await writable.write(getDataBlob());
                    await writable.close();
                    setNeedsSave(false);
                    setMessage({ type: 'success', text: `Enregistré : ${fileHandleRef.current.name}` });
                    setTimeout(() => setMessage(null), 3000);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        setMessage({ type: 'error', text: 'Erreur lors de la sauvegarde' });
                        setTimeout(() => setMessage(null), 3000);
                    }
                }
            };

            const loadDataFromFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.employees) setEmployees(data.employees);
                        if (data.chantiers) setChantiers(data.chantiers);
                        if (data.absences) setAbsences(data.absences);
                        if (data.retards) setRetards(data.retards);
                        if (data.heuresSupp) setHeuresSupp(data.heuresSupp);
                        setMessage({ type: 'success', text: 'Données chargées avec succès' });
                        setTimeout(() => setMessage(null), 3000);
                    } catch {
                        setMessage({ type: 'error', text: 'Erreur lors du chargement' });
                        setTimeout(() => setMessage(null), 3000);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // ─── AUTH ───
            const handleLogin = (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                const creds = getStoredAuth();
                if (username === creds.username && password === creds.password) {
                    setAuthenticated(true);
                } else {
                    setMessage({ type: 'error', text: 'Identifiants incorrects' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            const changePassword = (oldPwd, newPwd) => {
                const creds = getStoredAuth();
                if (oldPwd !== creds.password) {
                    setMessage({ type: 'error', text: 'Ancien mot de passe incorrect' });
                    setTimeout(() => setMessage(null), 3000);
                    return false;
                }
                setStoredAuth({ ...creds, password: newPwd });
                setMessage({ type: 'success', text: 'Mot de passe changé avec succès' });
                setTimeout(() => setMessage(null), 3000);
                setShowPasswordModal(false);
                return true;
            };

            // ─── STATS ───
            const getTodayStats = () => {
                const today = new Date().toISOString().split('T')[0];
                const todayRetards = retards.filter(r => r.date === today);
                const todayAbsences = absences.filter(a => {
                    const s = new Date(a.dateDebut + 'T00:00:00');
                    const f = new Date(a.dateFin + 'T00:00:00');
                    const t = new Date(today + 'T00:00:00');
                    return t >= s && t <= f;
                });
                const present = employees.length - todayAbsences.length;
                const late = todayRetards.length;
                const absent = todayAbsences.length;
                const lateEmployees = todayRetards.map(r => { const emp = employees.find(e => e.id === r.employeeId); return emp ? `${emp.nom} (${r.minutes} min)` : ''; }).filter(Boolean);
                const absentEmployees = todayAbsences.map(a => { const emp = employees.find(e => e.id === a.employeeId); return emp ? `${emp.nom} (${a.motif})` : ''; }).filter(Boolean);
                return { present, late, absent, lateEmployees, absentEmployees };
            };

            // ─── EMPLOYEES CRUD ───
            const saveEmployee = (empData) => {
                if (editingEmployee) {
                    setEmployees(employees.map(e => e.id === editingEmployee.id ? empData : e));
                    setMessage({ type: 'success', text: 'Employé modifié' });
                } else {
                    setEmployees([...employees, { ...empData, id: Date.now().toString(), cpBase: empData.cpBase || 25, cpStartMonth: new Date().getMonth() }]);
                    setMessage({ type: 'success', text: 'Employé ajouté' });
                }
                setShowModal(false); setEditingEmployee(null);
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteEmployee = (id) => {
                if (confirm('Supprimer cet employé ?')) {
                    setEmployees(employees.filter(e => e.id !== id));
                    setAbsences(absences.filter(a => a.employeeId !== id));
                    setRetards(retards.filter(r => r.employeeId !== id));
                    setHeuresSupp(heuresSupp.filter(h => h.employeeId !== id));
                    setMessage({ type: 'success', text: 'Employé supprimé' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            // ─── CHANTIERS CRUD ───
            const saveChantier = (data) => {
                const zoneInfo = getZone(data.lieu);
                const ch = { ...data, zone: zoneInfo.zone, panier: zoneInfo.panier };
                if (editingChantier) {
                    setChantiers(chantiers.map(c => c.id === editingChantier.id ? ch : c));
                    setMessage({ type: 'success', text: 'Chantier modifié' });
                } else {
                    setChantiers([...chantiers, { ...ch, id: Date.now().toString() }]);
                    setMessage({ type: 'success', text: 'Chantier ajouté' });
                }
                setShowChantierModal(false); setEditingChantier(null);
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteChantier = (id) => {
                if (confirm('Supprimer ce chantier ?')) {
                    setChantiers(chantiers.filter(c => c.id !== id));
                    setMessage({ type: 'success', text: 'Chantier supprimé' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            // ─── EXPORT (colored & styled) ───
            const exportEmployee = (employeeId) => {
                const employee = employees.find(e => e.id === employeeId);
                if (!employee) return;
                const wb = XLSX.utils.book_new();
                const year = new Date().getFullYear();
                const months = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];

                // Colors
                const primaryHex = '3D3573';
                const secondaryHex = 'E84597';
                const lightPrimary = 'EDE9F5';
                const lightGreen = 'D1FAE5';
                const lightRed = 'FEE2E2';
                const lightOrange = 'FEF3C7';
                const lightGray = 'F3F4F6';
                const whiteHex = 'FFFFFF';
                const darkGray = '9CA3AF';

                const headerFill = { patternType: 'solid', fgColor: { rgb: primaryHex } };
                const headerFont = { bold: true, color: { rgb: whiteHex }, sz: 11, name: 'Calibri' };
                const titleFill = { patternType: 'solid', fgColor: { rgb: secondaryHex } };
                const titleFont = { bold: true, color: { rgb: whiteHex }, sz: 14, name: 'Calibri' };
                const subtitleFont = { bold: true, color: { rgb: primaryHex }, sz: 11, name: 'Calibri' };
                const normalFont = { sz: 10, name: 'Calibri', color: { rgb: '2A2547' } };
                const absenceFont = { sz: 10, name: 'Calibri', color: { rgb: 'B91C1C' }, bold: true };
                const reposFont = { sz: 10, name: 'Calibri', color: { rgb: '6B7280' }, italic: true };
                const totalLabelFont = { bold: true, sz: 11, name: 'Calibri', color: { rgb: primaryHex } };
                const totalValueFont = { bold: true, sz: 12, name: 'Calibri', color: { rgb: primaryHex } };

                // Borders – solid visible
                const borderData = { style: 'thin', color: { rgb: '9CA3AF' } };       // données : gris médium
                const borderHeader = { style: 'medium', color: { rgb: whiteHex } };   // en-tête : blanc sur fond violet
                const borderTitle = { style: 'thin', color: { rgb: secondaryHex } };  // titre : rose
                const borderTotals = { style: 'medium', color: { rgb: primaryHex } }; // totaux : violet fort

                const cellBorder  = { top: borderData, bottom: borderData, left: borderData, right: borderData };
                const headerBorder = { top: borderHeader, bottom: borderHeader, left: borderHeader, right: borderHeader };
                const titleBorder  = { top: borderTitle, bottom: borderTitle, left: borderTitle, right: borderTitle };
                const totalBorder  = { top: borderTotals, bottom: borderTotals, left: borderTotals, right: borderTotals };

                const cpBal = computeCPBalance(employee, absences);

                months.forEach((monthName, monthIndex) => {
                    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                    const ws = {};
                    const range = { s: { c: 0, r: 0 }, e: { c: 7, r: 0 } };
                    let row = 0;

                    // Title row
                    ws[XLSX.utils.encode_cell({ c: 0, r: row })] = {
                        v: `Planning – ${employee.nom} – ${monthName} ${year}`,
                        t: 's',
                        s: { font: titleFont, fill: titleFill, alignment: { horizontal: 'center', vertical: 'center', wrapText: true }, border: titleBorder }
                    };
                    for (let c = 1; c <= 7; c++) {
                        ws[XLSX.utils.encode_cell({ c, r: row })] = { v: '', t: 's', s: { fill: titleFill, border: titleBorder } };
                    }
                    ws['!merges'] = ws['!merges'] || [];
                    ws['!merges'].push({ s: { c: 0, r: row }, e: { c: 7, r: row } });
                    row++;

                    // CP summary row
                    const cpBorderMed = { style: 'medium', color: { rgb: primaryHex } };
                    const cpRowBorder = { top: cpBorderMed, bottom: cpBorderMed, left: cpBorderMed, right: cpBorderMed };
                    ws[XLSX.utils.encode_cell({ c: 0, r: row })] = { v: `CP Base: ${cpBal.base} | Accumulés: +${cpBal.accumulated} | Utilisés: ${cpBal.used} | Solde: ${cpBal.balance}`, t: 's', s: { font: { bold: true, sz: 10, name: 'Calibri', color: { rgb: primaryHex } }, fill: { patternType: 'solid', fgColor: { rgb: lightPrimary } }, alignment: { horizontal: 'center' }, border: cpRowBorder } };
                    for (let c = 1; c <= 7; c++) {
                        ws[XLSX.utils.encode_cell({ c, r: row })] = { v: '', t: 's', s: { fill: { patternType: 'solid', fgColor: { rgb: lightPrimary } }, border: cpRowBorder } };
                    }
                    ws['!merges'].push({ s: { c: 0, r: row }, e: { c: 7, r: row } });
                    row++;

                    // Headers
                    const headers = ['Date', 'Jour', 'Heures', 'Chantier', 'Zone', 'Panier (€)', 'Retard (min)', 'Absence'];
                    headers.forEach((h, c) => {
                        ws[XLSX.utils.encode_cell({ c, r: row })] = { v: h, t: 's', s: { font: headerFont, fill: headerFill, alignment: { horizontal: 'center', vertical: 'center' }, border: headerBorder } };
                    });
                    row++;

                    let totalHeures = 0, totalPanier = 0, totalHeuresSupp = 0, totalRetards = 0, totalConges = 0;
                    let absencesByMotif = {};

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, monthIndex, day);
                        const dateStr = date.toISOString().split('T')[0];
                        const dayNames = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
                        const dayNamesLower = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
                        const dayOfWeek = dayNames[date.getDay()];
                        const dayName = dayNamesLower[date.getDay()];
                        const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                        // Check absence
                        const absence = absences.find(a => a.employeeId === employeeId && new Date(a.dateDebut+'T00:00:00') <= date && new Date(a.dateFin+'T00:00:00') >= date);

                        let rowData, rowStyle;
                        if (absence) {
                            rowData = [dateStr, dayOfWeek, 0, '', '', 0, 0, absence.motif];
                            if (absence.motif === 'Congés payés') { totalConges++; rowStyle = { patternType: 'solid', fgColor: { rgb: lightGreen } }; }
                            else { rowStyle = { patternType: 'solid', fgColor: { rgb: lightRed } }; }
                            absencesByMotif[absence.motif] = (absencesByMotif[absence.motif] || 0) + 1;
                        } else if (isWeekend) {
                            rowData = [dateStr, dayOfWeek, '', '', '', '', '', 'Repos'];
                            rowStyle = { patternType: 'solid', fgColor: { rgb: lightGray } };
                        } else {
                            const schedule = employee.horaires?.[dayName];
                            if (!schedule || !schedule.debut || !schedule.fin) {
                                rowData = [dateStr, dayOfWeek, 0, '', '', 0, 0, 'Repos'];
                                rowStyle = { patternType: 'solid', fgColor: { rgb: lightGray } };
                            } else {
                                const debut = new Date(`2000-01-01T${schedule.debut}`);
                                const fin = new Date(`2000-01-01T${schedule.fin}`);
                                let heures = (fin - debut) / (1000 * 60 * 60);

                                const chantierAssignment = chantiers.find(c => {
                                    const hasEmp = c.employees?.some(e => e.employeeId === employeeId && new Date(e.dateDebut+'T00:00:00') <= date && new Date(e.dateFin+'T00:00:00') >= date);
                                    return hasEmp && new Date(c.dateDebut+'T00:00:00') <= date && new Date(c.dateFin+'T00:00:00') >= date;
                                });

                                const chantierNom = chantierAssignment?.nom || '';
                                const zone = chantierAssignment?.zone !== undefined ? chantierAssignment.zone : '';
                                const panier = chantierAssignment?.panier || 0;

                                const retard = retards.find(r => r.employeeId === employeeId && r.date === dateStr);
                                const retardMinutes = retard?.minutes || 0;

                                const hSupp = heuresSupp.find(h => h.employeeId === employeeId && h.date === dateStr);
                                if (hSupp) {
                                    if (hSupp.type === 'arrivee') { const hr = new Date(`2000-01-01T${hSupp.heureReelle}`); heures += (debut - hr) / (1000*60*60); }
                                    else { const hr = new Date(`2000-01-01T${hSupp.heureReelle}`); heures += (hr - fin) / (1000*60*60); }
                                    totalHeuresSupp += Math.abs(hSupp.heureReelle && schedule[hSupp.type==='arrivee'?'debut':'fin'] ? (new Date(`2000-01-01T${hSupp.heureReelle}`) - new Date(`2000-01-01T${schedule[hSupp.type==='arrivee'?'debut':'fin']}`)) / (1000*60*60) : 0);
                                }

                                totalHeures += heures; totalPanier += panier; totalRetards += retardMinutes;
                                rowData = [dateStr, dayOfWeek, parseFloat(heures.toFixed(2)), chantierNom, zone, panier, retardMinutes, ''];
                                rowStyle = retardMinutes > 0 ? { patternType: 'solid', fgColor: { rgb: lightOrange } } : { patternType: 'solid', fgColor: { rgb: whiteHex } };
                            }
                        }

                        const usedFont = absence ? absenceFont : (isWeekend ? reposFont : normalFont);
                        rowData.forEach((val, c) => {
                            ws[XLSX.utils.encode_cell({ c, r: row })] = {
                                v: val, t: typeof val === 'number' ? 'n' : 's',
                                s: { font: usedFont, fill: rowStyle, border: cellBorder, alignment: { horizontal: c === 0 || c === 1 ? 'left' : 'center' } }
                            };
                        });
                        row++;
                    }

                    // Totals section
                    row++;
                    const totalsData = [
                        ['Total heures travaillées', totalHeures.toFixed(2)],
                        ['Montant paniers', `${totalPanier.toFixed(2)} €`],
                        ['Heures supplémentaires', totalHeuresSupp.toFixed(2)],
                        ['Congés payés (jours)', totalConges],
                        ['Total retards (min)', totalRetards]
                    ];

                    ws[XLSX.utils.encode_cell({ c: 0, r: row })] = { v: 'RÉSUMÉ DU MOIS', t: 's', s: { font: { bold: true, sz: 12, name: 'Calibri', color: { rgb: whiteHex } }, fill: headerFill, alignment: { horizontal: 'center' }, border: totalBorder } };
                    for (let c = 1; c <= 7; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = { v: '', t: 's', s: { fill: headerFill, border: totalBorder } };
                    ws['!merges'].push({ s: { c: 0, r: row }, e: { c: 7, r: row } });
                    row++;

                    totalsData.forEach(([label, value]) => {
                        ws[XLSX.utils.encode_cell({ c: 0, r: row })] = { v: label, t: 's', s: { font: totalLabelFont, fill: { patternType: 'solid', fgColor: { rgb: lightPrimary } }, border: totalBorder } };
                        ws[XLSX.utils.encode_cell({ c: 1, r: row })] = { v: value, t: 's', s: { font: totalValueFont, fill: { patternType: 'solid', fgColor: { rgb: lightPrimary } }, border: totalBorder, alignment: { horizontal: 'right' } } };
                        for (let c = 2; c <= 7; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = { v: '', t: 's', s: { fill: { patternType: 'solid', fgColor: { rgb: lightPrimary } }, border: totalBorder } };
                        ws['!merges'].push({ s: { c: 0, r: row }, e: { c: 0, r: row } });
                        ws['!merges'].push({ s: { c: 1, r: row }, e: { c: 7, r: row } });
                        row++;
                    });

                    if (Object.keys(absencesByMotif).length > 0) {
                        row++;
                        // Sub-header "ABSENCES PAR MOTIF"
                        const subHdrFill = { patternType: 'solid', fgColor: { rgb: 'E9D5FF' } };   // lavender
                        const subHdrBorder = { style: 'medium', color: { rgb: primaryHex } };
                        const subHdrCell  = { top: subHdrBorder, bottom: subHdrBorder, left: subHdrBorder, right: subHdrBorder };
                        ws[XLSX.utils.encode_cell({ c: 0, r: row })] = { v: 'ABSENCES PAR MOTIF', t: 's', s: { font: { bold: true, sz: 11, name: 'Calibri', color: { rgb: primaryHex } }, fill: subHdrFill, border: subHdrCell } };
                        ws[XLSX.utils.encode_cell({ c: 1, r: row })] = { v: 'Jours', t: 's', s: { font: { bold: true, sz: 11, name: 'Calibri', color: { rgb: primaryHex } }, fill: subHdrFill, border: subHdrCell, alignment: { horizontal: 'center' } } };
                        for (let c = 2; c <= 7; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = { v: '', t: 's', s: { fill: subHdrFill, border: subHdrCell } };
                        ws['!merges'].push({ s: { c: 0, r: row }, e: { c: 0, r: row } });
                        ws['!merges'].push({ s: { c: 1, r: row }, e: { c: 7, r: row } });
                        row++;
                        Object.entries(absencesByMotif).forEach(([motif, count]) => {
                            ws[XLSX.utils.encode_cell({ c: 0, r: row })] = { v: motif, t: 's', s: { font: { bold: true, sz: 10, name: 'Calibri', color: { rgb: '2A2547' } }, fill: { patternType: 'solid', fgColor: { rgb: lightGray } }, border: cellBorder } };
                            ws[XLSX.utils.encode_cell({ c: 1, r: row })] = { v: count, t: 'n', s: { font: { bold: true, sz: 11, name: 'Calibri', color: { rgb: primaryHex } }, fill: { patternType: 'solid', fgColor: { rgb: lightGray } }, border: cellBorder, alignment: { horizontal: 'center' } } };
                            for (let c = 2; c <= 7; c++) ws[XLSX.utils.encode_cell({ c, r: row })] = { v: '', t: 's', s: { fill: { patternType: 'solid', fgColor: { rgb: lightGray } }, border: cellBorder } };
                            row++;
                        });
                    }

                    if (row > range.e.r) range.e.r = row - 1;
                    ws['!ref'] = XLSX.utils.encode_range(range);
                    ws['!cols'] = [{ wch: 14 }, { wch: 12 }, { wch: 10 }, { wch: 22 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 16 }];
                    ws['!rows'] = [];
                    for (let r = 0; r <= row; r++) {
                        if (r === 0) ws['!rows'].push({ ht: 32 });       // titre
                        else if (r === 1) ws['!rows'].push({ ht: 24 }); // CP
                        else if (r === 2) ws['!rows'].push({ ht: 22 }); // en-tête colonnes
                        else ws['!rows'].push({ ht: 20 });              // données
                    }

                    XLSX.utils.book_append_sheet(wb, ws, monthName);
                });

                XLSX.writeFile(wb, `Planning_${employee.nom}_${year}.xlsx`);
                setMessage({ type: 'success', text: 'Planning exporté avec succès' });
                setTimeout(() => setMessage(null), 3000);
            };

            // ─── RENDER ───
            if (!authenticated) {
                return <LoginForm onLogin={handleLogin} message={message} />;
            }

            const stats = getTodayStats();

            return (
                <div className="app">
                    <header className="header">
                        <div className="header-left">
                            <img className="header-logo" src={`data:image/webp;base64,${LOGO_B64}`} alt="Logo" />
                            <div className="header-title">
                                <h1>Thierry Carles</h1>
                                <p>Gestion du Personnel</p>
                            </div>
                        </div>
                        <div className="header-actions">
                            {needsSave && <span className="unsaved-badge">⚠️ Non sauvegardé</span>}
                            <input type="file" id="fileInput" accept=".json" style={{ display: 'none' }} onChange={loadDataFromFile} />
                            <button className="logout-btn" onClick={() => document.getElementById('fileInput').click()}>📂 Charger</button>
                            <button className="logout-btn" onClick={saveDataQuick} style={needsSave ? { background: 'rgba(255,193,7,0.3)', borderColor: 'rgba(255,193,7,0.5)', animation: 'pulse 2s infinite' } : {}}>💾 Enregistrer</button>
                            <button className="logout-btn" onClick={saveDataToFile}>💾 Enregistrer sous…</button>
                            <button className="logout-btn" onClick={() => setShowPasswordModal(true)}>🔐 Mot de passe</button>
                            <button className="logout-btn" onClick={() => setAuthenticated(false)}>Déconnexion</button>
                        </div>
                    </header>

                    {message && <div className={message.type === 'error' ? 'error-message' : 'success-message'}>{message.text}</div>}

                    <div className="tabs">
                        {[['dashboard','Tableau de Bord'],['employees','Employés'],['modifications','Modifications'],['chantiers','Chantiers'],['export','Export']].map(([key, label]) => (
                            <button key={key} className={`tab ${activeTab === key ? 'active' : ''}`} onClick={() => setActiveTab(key)}>{label}</button>
                        ))}
                    </div>

                    {activeTab === 'dashboard' && <Dashboard stats={stats} />}
                    {activeTab === 'employees' && (
                        <EmployeesTab employees={employees} absences={absences}
                            onAdd={() => { setEditingEmployee(null); setShowModal(true); }}
                            onEdit={(emp) => { setEditingEmployee(emp); setShowModal(true); }}
                            onDelete={deleteEmployee}
                        />
                    )}
                    {activeTab === 'modifications' && (
                        <ModificationsTab employees={employees} absences={absences} setAbsences={setAbsences}
                            retards={retards} setRetards={setRetards}
                            heuresSupp={heuresSupp} setHeuresSupp={setHeuresSupp} setMessage={setMessage} />
                    )}
                    {activeTab === 'chantiers' && (
                        <ChantiersTab chantiers={chantiers} employees={employees}
                            onAdd={() => { setEditingChantier(null); setShowChantierModal(true); }}
                            onEdit={(ch) => { setEditingChantier(ch); setShowChantierModal(true); }}
                            onDelete={deleteChantier} setChantiers={setChantiers} setMessage={setMessage} />
                    )}
                    {activeTab === 'export' && <ExportTab employees={employees} onExport={exportEmployee} />}

                    {showModal && <EmployeeModal employee={editingEmployee} onSave={saveEmployee} onClose={() => { setShowModal(false); setEditingEmployee(null); }} />}
                    {showChantierModal && <ChantierModal chantier={editingChantier} employees={employees} onSave={saveChantier} onClose={() => { setShowChantierModal(false); setEditingChantier(null); }} />}
                    {showPasswordModal && <PasswordModal onSave={changePassword} onClose={() => setShowPasswordModal(false)} />}
                </div>
            );
        }

        // ─── LOGIN ───
        function LoginForm({ onLogin, message }) {
            return (
                <div className="login-page">
                    <div className="login-container">
                        <div className="login-logo-wrap">
                            <img className="login-logo" src={`data:image/webp;base64,${LOGO_B64}`} alt="Logo Thierry Carles" />
                        </div>
                        <h2>Connexion</h2>
                        <p>Accédez à la gestion du personnel</p>
                        {message && message.type === 'error' && <div className="error-message">{message.text}</div>}
                        <form onSubmit={onLogin}>
                            <div className="input-group">
                                <label>Nom d'utilisateur</label>
                                <input type="text" name="username" required />
                            </div>
                            <div className="input-group">
                                <label>Mot de passe</label>
                                <input type="password" name="password" required />
                            </div>
                            <button type="submit" className="primary-btn">Se connecter</button>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── PASSWORD MODAL ───
        function PasswordModal({ onSave, onClose }) {
            const [oldPwd, setOldPwd] = useState('');
            const [newPwd, setNewPwd] = useState('');
            const [confirmPwd, setConfirmPwd] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (newPwd !== confirmPwd) { setError('Les mots de passe ne correspondent pas'); return; }
                if (newPwd.length < 3) { setError('Le mot de passe doit avoir au moins 3 caractères'); return; }
                setError('');
                onSave(oldPwd, newPwd);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal" style={{ maxWidth: '440px' }}>
                        <h3>🔐 Modifier le mot de passe</h3>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Ancien mot de passe</label>
                                <input type="password" value={oldPwd} onChange={e => setOldPwd(e.target.value)} required />
                            </div>
                            <div className="form-group">
                                <label>Nouveau mot de passe</label>
                                <input type="password" value={newPwd} onChange={e => setNewPwd(e.target.value)} required />
                            </div>
                            <div className="form-group">
                                <label>Confirmer le nouveau mot de passe</label>
                                <input type="password" value={confirmPwd} onChange={e => setConfirmPwd(e.target.value)} required />
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Annuler</button>
                                <button type="submit" className="btn btn-edit">Changer</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── DASHBOARD ───
        function Dashboard({ stats }) {
            return (
                <div className="stats-grid">
                    <div className="stat-card present">
                        <h4>Présents</h4>
                        <div className="value">{stats.present}</div>
                    </div>
                    <div className="stat-card late">
                        <h4>Retards aujourd'hui</h4>
                        <div className="value">{stats.late}</div>
                        <div className="list">{stats.lateEmployees.length > 0 ? stats.lateEmployees.join(', ') : 'Aucun retard'}</div>
                    </div>
                    <div className="stat-card absent">
                        <h4>Absents</h4>
                        <div className="value">{stats.absent}</div>
                        <div className="list">{stats.absentEmployees.length > 0 ? stats.absentEmployees.join(', ') : 'Aucune absence'}</div>
                    </div>
                </div>
            );
        }

        // ─── EMPLOYEES TAB ───
        function EmployeesTab({ employees, absences, onAdd, onEdit, onDelete }) {
            const [selectedEmp, setSelectedEmp] = useState(null);
            const [detailTab, setDetailTab] = useState('absences');

            const empAbsences = selectedEmp ? absences.filter(a => a.employeeId === selectedEmp.id) : [];
            const cpBal = selectedEmp ? computeCPBalance(selectedEmp, absences) : null;

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '18px' }}>
                            <h3>Gestion des Employés</h3>
                            <button className="btn btn-edit" onClick={onAdd}>+ Ajouter</button>
                        </div>
                        <div className="employee-list">
                            {employees.length === 0 ? (
                                <p style={{ textAlign: 'center', color: 'var(--text-light)', padding: '36px' }}>Aucun employé enregistré</p>
                            ) : employees.map(emp => (
                                <div key={emp.id} className="employee-item" style={selectedEmp?.id === emp.id ? { border: '2px solid var(--secondary)', background: '#fdf2f8' } : {}}>
                                    <div className="employee-info" style={{ cursor: 'pointer' }} onClick={() => setSelectedEmp(selectedEmp?.id === emp.id ? null : emp)}>
                                        <h4>{emp.nom}</h4>
                                        <p>Cliquez pour voir les détails</p>
                                    </div>
                                    <div className="employee-actions">
                                        <button className="btn btn-edit" onClick={() => onEdit(emp)}>Modifier</button>
                                        <button className="btn btn-delete" onClick={() => onDelete(emp.id)}>Supprimer</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {selectedEmp && (
                        <div className="detail-panel">
                            <div className="detail-panel-header">
                                <h4>📋 Détails – {selectedEmp.nom}</h4>
                                <button style={{ background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white', cursor: 'pointer', fontSize: '18px', borderRadius: '6px', padding: '2px 8px' }} onClick={() => setSelectedEmp(null)}>×</button>
                            </div>
                            <div className="detail-panel-body">
                                {cpBal && (
                                    <div className="cp-summary">
                                        <div className="cp-card">
                                            <div className="cp-label">CP de base (année)</div>
                                            <div className="cp-value">{cpBal.base}</div>
                                        </div>
                                        <div className="cp-card">
                                            <div className="cp-label">Accumulés (+2.5/mois)</div>
                                            <div className="cp-value" style={{ color: 'var(--success)' }}>+{cpBal.accumulated}</div>
                                        </div>
                                        <div className="cp-card">
                                            <div className="cp-label">Utilisés</div>
                                            <div className="cp-value warning">{cpBal.used}</div>
                                        </div>
                                        <div className="cp-card">
                                            <div className="cp-label">Solde CP</div>
                                            <div className={`cp-value ${cpBal.balance < 0 ? 'danger' : ''}`}>{cpBal.balance}</div>
                                        </div>
                                    </div>
                                )}

                                <div className="detail-tabs" style={{ marginTop: '18px' }}>
                                    <button className={`detail-tab ${detailTab === 'absences' ? 'active' : ''}`} onClick={() => setDetailTab('absences')}>Absences</button>
                                    <button className={`detail-tab ${detailTab === 'horaires' ? 'active' : ''}`} onClick={() => setDetailTab('horaires')}>Horaires</button>
                                </div>

                                {detailTab === 'absences' && (
                                    <div>
                                        {empAbsences.length === 0 ? (
                                            <p style={{ color: 'var(--text-light)', fontSize: '13px', padding: '12px 0' }}>Aucune absence enregistrée</p>
                                        ) : empAbsences.map(abs => {
                                            const motifClass = abs.motif === 'Congés payés' ? 'motif-cp' : abs.motif === 'Maladie' ? 'motif-maladie' : 'motif-other';
                                            return (
                                                <div key={abs.id} className="absence-list-item">
                                                    <div>
                                                        <span style={{ fontSize: '13px', fontWeight: '600', color: 'var(--text-dark)' }}>
                                                            {new Date(abs.dateDebut+'T00:00:00').toLocaleDateString('fr-FR')} → {new Date(abs.dateFin+'T00:00:00').toLocaleDateString('fr-FR')}
                                                        </span>
                                                        <span style={{ fontSize: '11px', color: 'var(--text-light)', marginLeft: '10px' }}>
                                                            ({countWorkDays(abs.dateDebut, abs.dateFin)} jour{countWorkDays(abs.dateDebut, abs.dateFin) > 1 ? 's' : ''})
                                                        </span>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                        <span className={`motif-tag ${motifClass}`}>{abs.motif}</span>
                                                        <button className="btn btn-delete" style={{ padding: '4px 10px', fontSize: '11px' }} onClick={() => {
                                                            // We need a way to delete — pass setAbsences via props or use a callback
                                                            // For simplicity, we'll use a custom event approach; but since we have no direct access here,
                                                            // we'll handle it via a global-like approach. For now, just show.
                                                        }}>×</button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {detailTab === 'horaires' && (
                                    <div style={{ display: 'grid', gap: '6px' }}>
                                        {['lundi','mardi','mercredi','jeudi','vendredi','samedi','dimanche'].map(jour => {
                                            const h = selectedEmp.horaires?.[jour];
                                            const hasHoraires = h?.debut && h?.fin;
                                            return (
                                                <div key={jour} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 12px', background: 'var(--bg-light)', borderRadius: '8px' }}>
                                                    <span style={{ fontWeight: '600', fontSize: '13px', textTransform: 'capitalize', color: 'var(--text-dark)', minWidth: '90px' }}>{jour}</span>
                                                    {hasHoraires ? (
                                                        <span style={{ fontSize: '13px', color: 'var(--primary)', fontWeight: '600' }}>{h.debut} – {h.fin}</span>
                                                    ) : (
                                                        <span style={{ fontSize: '12px', color: 'var(--text-light)', fontStyle: 'italic' }}>Repos</span>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ─── EMPLOYEE MODAL ───
        function EmployeeModal({ employee, onSave, onClose }) {
            const [formData, setFormData] = useState(employee || {
                nom: '', cpBase: 25,
                horaires: { lundi:{debut:'',fin:''}, mardi:{debut:'',fin:''}, mercredi:{debut:'',fin:''}, jeudi:{debut:'',fin:''}, vendredi:{debut:'',fin:''}, samedi:{debut:'',fin:''}, dimanche:{debut:'',fin:''} }
            });

            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
            const updateHoraire = (jour, type, value) => setFormData({ ...formData, horaires: { ...formData.horaires, [jour]: { ...formData.horaires[jour], [type]: value } } });

            const jours = ['lundi','mardi','mercredi','jeudi','vendredi','samedi','dimanche'];

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h3>{employee ? "Modifier l'employé" : 'Nouvel employé'}</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Nom complet</label>
                                <input type="text" value={formData.nom} onChange={e => setFormData({ ...formData, nom: e.target.value })} required />
                            </div>
                            <div className="form-group">
                                <label>Nombre de CP de base (jours/an)</label>
                                <input type="number" value={formData.cpBase || 25} min="0" max="50" step="0.5"
                                    onChange={e => setFormData({ ...formData, cpBase: parseFloat(e.target.value) || 0 })} />
                            </div>
                            <h4 style={{ marginTop: '20px', marginBottom: '12px', color: 'var(--primary)', fontSize: '14px' }}>Horaires hebdomadaires</h4>
                            <div className="schedule-grid">
                                {jours.map(jour => (
                                    <div key={jour} className="schedule-day">
                                        <label style={{ textTransform: 'capitalize' }}>{jour}</label>
                                        <div className="time-inputs">
                                            <input type="time" value={formData.horaires[jour]?.debut || ''} onChange={e => updateHoraire(jour, 'debut', e.target.value)} />
                                        </div>
                                        <div className="time-inputs">
                                            <input type="time" value={formData.horaires[jour]?.fin || ''} onChange={e => updateHoraire(jour, 'fin', e.target.value)} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Annuler</button>
                                <button type="submit" className="btn btn-edit">Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── MODIFICATIONS TAB ───
        function ModificationsTab({ employees, absences, setAbsences, retards, setRetards, heuresSupp, setHeuresSupp, setMessage }) {
            const [selectedEmp, setSelectedEmp] = useState('');
            const [absenceForm, setAbsenceForm] = useState({ employeeId:'', dateDebut:'', dateFin:'', motif:'Congés payés' });
            const [retardForm, setRetardForm] = useState({ employeeId:'', date:'', minutes:0 });
            const [heureSuppForm, setHeureSuppForm] = useState({ employeeId:'', date:'', type:'arrivee', heureReelle:'' });

            const motifsAbsence = ['Congés payés','Maladie','Congé sans solde','Formation','Événement familial','Autre'];

            // When user selects employee, filter all forms
            const empAbsences = selectedEmp ? absences.filter(a => a.employeeId === selectedEmp) : [];
            const empRetards = selectedEmp ? retards.filter(r => r.employeeId === selectedEmp) : [];
            const empHeuresSupp = selectedEmp ? heuresSupp.filter(h => h.employeeId === selectedEmp) : [];

            const handleAbsenceSubmit = (e) => {
                e.preventDefault();
                const form = { ...absenceForm, employeeId: selectedEmp };
                if (!form.employeeId || !form.dateDebut || !form.dateFin) return;
                setAbsences([...absences, { id: Date.now().toString(), ...form }]);
                setAbsenceForm({ employeeId:'', dateDebut:'', dateFin:'', motif:'Congés payés' });
                setMessage({ type:'success', text:'Absence enregistrée' });
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteAbsence = (id) => {
                setAbsences(absences.filter(a => a.id !== id));
                setMessage({ type:'success', text:'Absence supprimée' });
                setTimeout(() => setMessage(null), 3000);
            };

            const handleRetardSubmit = (e) => {
                e.preventDefault();
                const form = { ...retardForm, employeeId: selectedEmp };
                if (!form.employeeId || !form.date || !form.minutes) return;
                setRetards([...retards, { id: Date.now().toString(), ...form, minutes: parseInt(form.minutes) }]);
                setRetardForm({ employeeId:'', date:'', minutes:0 });
                setMessage({ type:'success', text:'Retard enregistré' });
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteRetard = (id) => {
                setRetards(retards.filter(r => r.id !== id));
                setMessage({ type:'success', text:'Retard supprimé' });
                setTimeout(() => setMessage(null), 3000);
            };

            const handleHeureSuppSubmit = (e) => {
                e.preventDefault();
                const form = { ...heureSuppForm, employeeId: selectedEmp };
                if (!form.employeeId || !form.date || !form.heureReelle) return;
                setHeuresSupp([...heuresSupp, { id: Date.now().toString(), ...form }]);
                setHeureSuppForm({ employeeId:'', date:'', type:'arrivee', heureReelle:'' });
                setMessage({ type:'success', text:'Heures supplémentaires enregistrées' });
                setTimeout(() => setMessage(null), 3000);
            };

            const deleteHeureSupp = (id) => {
                setHeuresSupp(heuresSupp.filter(h => h.id !== id));
                setMessage({ type:'success', text:'Heures supplémentaires supprimées' });
                setTimeout(() => setMessage(null), 3000);
            };

            const empName = selectedEmp ? employees.find(e => e.id === selectedEmp)?.nom : '';

            return (
                <div>
                    {/* Employee selector */}
                    <div className="card">
                        <h3>Sélectionner un employé</h3>
                        <div className="form-group" style={{ marginBottom: 0 }}>
                            <select value={selectedEmp} onChange={e => setSelectedEmp(e.target.value)} style={{ maxWidth: '320px' }}>
                                <option value="">Choisir un employé...</option>
                                {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.nom}</option>)}
                            </select>
                        </div>
                    </div>

                    {selectedEmp && (
                        <>
                            {/* Absences */}
                            <div className="card">
                                <h3>Absences – {empName}</h3>
                                <form onSubmit={handleAbsenceSubmit}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date de début</label>
                                            <input type="date" value={absenceForm.dateDebut} onChange={e => setAbsenceForm({...absenceForm, dateDebut: e.target.value})} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Date de fin</label>
                                            <input type="date" value={absenceForm.dateFin} onChange={e => setAbsenceForm({...absenceForm, dateFin: e.target.value})} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Motif</label>
                                            <select value={absenceForm.motif} onChange={e => setAbsenceForm({...absenceForm, motif: e.target.value})} required>
                                                {motifsAbsence.map(m => <option key={m} value={m}>{m}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" className="btn btn-edit">+ Ajouter absence</button>
                                </form>
                                {empAbsences.length > 0 && (
                                    <div style={{ marginTop: '16px' }}>
                                        <p style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-light)', textTransform: 'uppercase', marginBottom: '8px' }}>Liste des absences</p>
                                        {empAbsences.map(abs => {
                                            const motifClass = abs.motif === 'Congés payés' ? 'motif-cp' : abs.motif === 'Maladie' ? 'motif-maladie' : 'motif-other';
                                            return (
                                                <div key={abs.id} className="absence-list-item">
                                                    <div>
                                                        <span style={{ fontSize: '13px', fontWeight: '600' }}>{new Date(abs.dateDebut+'T00:00:00').toLocaleDateString('fr-FR')} → {new Date(abs.dateFin+'T00:00:00').toLocaleDateString('fr-FR')}</span>
                                                        <span style={{ fontSize: '11px', color: 'var(--text-light)', marginLeft: '8px' }}>({countWorkDays(abs.dateDebut, abs.dateFin)} jour{countWorkDays(abs.dateDebut, abs.dateFin) > 1 ? 's' : ''})</span>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                        <span className={`motif-tag ${motifClass}`}>{abs.motif}</span>
                                                        <button className="btn btn-delete" style={{ padding: '4px 10px', fontSize: '11px' }} onClick={() => deleteAbsence(abs.id)}>Supprimer</button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* Retards */}
                            <div className="card">
                                <h3>Retards & Départs anticipés – {empName}</h3>
                                <form onSubmit={handleRetardSubmit}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date</label>
                                            <input type="date" value={retardForm.date} onChange={e => setRetardForm({...retardForm, date: e.target.value})} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Minutes (+ retard / − départ tôt)</label>
                                            <input type="number" value={retardForm.minutes} onChange={e => setRetardForm({...retardForm, minutes: e.target.value})} required />
                                        </div>
                                    </div>
                                    <button type="submit" className="btn btn-edit">+ Ajouter retard</button>
                                </form>
                                {empRetards.length > 0 && (
                                    <div style={{ marginTop: '16px' }}>
                                        <p style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-light)', textTransform: 'uppercase', marginBottom: '8px' }}>Liste des retards</p>
                                        {empRetards.map(ret => (
                                            <div key={ret.id} className="absence-list-item">
                                                <span style={{ fontSize: '13px', fontWeight: '600' }}>{new Date(ret.date+'T00:00:00').toLocaleDateString('fr-FR')} – {ret.minutes > 0 ? `+${ret.minutes} min` : `${ret.minutes} min`}</span>
                                                <button className="btn btn-delete" style={{ padding: '4px 10px', fontSize: '11px' }} onClick={() => deleteRetard(ret.id)}>Supprimer</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Heures Supp */}
                            <div className="card">
                                <h3>Heures Supplémentaires – {empName}</h3>
                                <form onSubmit={handleHeureSuppSubmit}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date</label>
                                            <input type="date" value={heureSuppForm.date} onChange={e => setHeureSuppForm({...heureSuppForm, date: e.target.value})} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Type</label>
                                            <select value={heureSuppForm.type} onChange={e => setHeureSuppForm({...heureSuppForm, type: e.target.value})}>
                                                <option value="arrivee">Arrivée anticipée</option>
                                                <option value="depart">Départ tardif</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Heure réelle</label>
                                            <input type="time" value={heureSuppForm.heureReelle} onChange={e => setHeureSuppForm({...heureSuppForm, heureReelle: e.target.value})} required />
                                        </div>
                                    </div>
                                    <button type="submit" className="btn btn-edit">+ Ajouter</button>
                                </form>
                                {empHeuresSupp.length > 0 && (
                                    <div style={{ marginTop: '16px' }}>
                                        <p style={{ fontSize: '12px', fontWeight: '600', color: 'var(--text-light)', textTransform: 'uppercase', marginBottom: '8px' }}>Liste des heures supplémentaires</p>
                                        {empHeuresSupp.map(hs => (
                                            <div key={hs.id} className="absence-list-item">
                                                <span style={{ fontSize: '13px', fontWeight: '600' }}>{new Date(hs.date+'T00:00:00').toLocaleDateString('fr-FR')} – {hs.type === 'arrivee' ? 'Arrivée' : 'Départ'} à {hs.heureReelle}</span>
                                                <button className="btn btn-delete" style={{ padding: '4px 10px', fontSize: '11px' }} onClick={() => deleteHeureSupp(hs.id)}>Supprimer</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // ─── CHANTIERS TAB ───
        function ChantiersTab({ chantiers, employees, onAdd, onEdit, onDelete, setChantiers, setMessage }) {
            const [showAssignModal, setShowAssignModal] = useState(false);
            const [selectedChantier, setSelectedChantier] = useState(null);
            const [assignForm, setAssignForm] = useState({ employeeId:'', dateDebut:'', dateFin:'' });

            const handleAssignEmployee = (chantier) => { setSelectedChantier(chantier); setShowAssignModal(true); setAssignForm({ employeeId:'', dateDebut:'', dateFin:'' }); };

            const submitAssignment = (e) => {
                e.preventDefault();
                if (!assignForm.employeeId || !assignForm.dateDebut || !assignForm.dateFin) return;
                setChantiers(chantiers.map(c => c.id === selectedChantier.id ? { ...c, employees: [...(c.employees||[]), { id: Date.now().toString(), ...assignForm }] } : c));
                setShowAssignModal(false); setSelectedChantier(null);
                setMessage({ type:'success', text:'Employé assigné au chantier' });
                setTimeout(() => setMessage(null), 3000);
            };

            const removeAssignment = (chantierId, assignmentId) => {
                if (confirm('Retirer cet employé ?')) {
                    setChantiers(chantiers.map(c => c.id === chantierId ? { ...c, employees: c.employees.filter(e => e.id !== assignmentId) } : c));
                    setMessage({ type:'success', text:'Assignation supprimée' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            return (
                <div className="card">
                    <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'18px' }}>
                        <h3>Gestion des Chantiers</h3>
                        <button className="btn btn-edit" onClick={onAdd}>+ Nouveau chantier</button>
                    </div>
                    {chantiers.length === 0 ? (
                        <p style={{ textAlign:'center', color:'var(--text-light)', padding:'36px' }}>Aucun chantier enregistré</p>
                    ) : chantiers.map(chantier => (
                        <div key={chantier.id} className="chantier-item">
                            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'start', marginBottom:'10px' }}>
                                <div>
                                    <h4>{chantier.nom}</h4>
                                    <p>{chantier.lieu}</p>
                                    <p>Du {new Date(chantier.dateDebut+'T00:00:00').toLocaleDateString('fr-FR')} au {new Date(chantier.dateFin+'T00:00:00').toLocaleDateString('fr-FR')}</p>
                                    <span className="badge badge-zone">Zone {chantier.zone} – Panier: {chantier.panier}€</span>
                                </div>
                                <div style={{ display:'flex', gap:'6px' }}>
                                    <button className="btn btn-secondary" onClick={() => handleAssignEmployee(chantier)}>Assigner</button>
                                    <button className="btn btn-edit" onClick={() => onEdit(chantier)}>Modifier</button>
                                    <button className="btn btn-delete" onClick={() => onDelete(chantier.id)}>Supprimer</button>
                                </div>
                            </div>
                            {chantier.employees && chantier.employees.length > 0 && (
                                <div className="employee-assignments">
                                    <h4 style={{ fontSize:'13px', marginBottom:'10px', color:'var(--primary)' }}>Employés assignés :</h4>
                                    {chantier.employees.map(assignment => {
                                        const emp = employees.find(e => e.id === assignment.employeeId);
                                        return emp ? (
                                            <div key={assignment.id} className="assignment-item">
                                                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                                                    <div>
                                                        <strong style={{ fontSize: '13px' }}>{emp.nom}</strong>
                                                        <p style={{ fontSize:'12px', color:'var(--text-light)', margin:'3px 0 0 0' }}>
                                                            Du {new Date(assignment.dateDebut+'T00:00:00').toLocaleDateString('fr-FR')} au {new Date(assignment.dateFin+'T00:00:00').toLocaleDateString('fr-FR')}
                                                        </p>
                                                    </div>
                                                    <button className="btn btn-delete" style={{ padding:'5px 10px', fontSize:'11px' }} onClick={() => removeAssignment(chantier.id, assignment.id)}>Retirer</button>
                                                </div>
                                            </div>
                                        ) : null;
                                    })}
                                </div>
                            )}
                        </div>
                    ))}

                    {showAssignModal && (
                        <div className="modal-overlay">
                            <div className="modal">
                                <h3>Assigner un employé</h3>
                                <p style={{ color:'var(--text-light)', marginBottom:'18px', fontSize: '13px' }}>Chantier : {selectedChantier.nom}</p>
                                <form onSubmit={submitAssignment}>
                                    <div className="form-group">
                                        <label>Employé</label>
                                        <select value={assignForm.employeeId} onChange={e => setAssignForm({...assignForm, employeeId: e.target.value})} required>
                                            <option value="">Sélectionner...</option>
                                            {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.nom}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Date de début</label>
                                            <input type="date" value={assignForm.dateDebut} onChange={e => setAssignForm({...assignForm, dateDebut: e.target.value})} min={selectedChantier.dateDebut} max={selectedChantier.dateFin} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Date de fin</label>
                                            <input type="date" value={assignForm.dateFin} onChange={e => setAssignForm({...assignForm, dateFin: e.target.value})} min={selectedChantier.dateDebut} max={selectedChantier.dateFin} required />
                                        </div>
                                    </div>
                                    <div className="modal-actions">
                                        <button type="button" className="btn btn-secondary" onClick={() => { setShowAssignModal(false); setSelectedChantier(null); }}>Annuler</button>
                                        <button type="submit" className="btn btn-edit">Assigner</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ─── CHANTIER MODAL ───
        function ChantierModal({ chantier, employees, onSave, onClose }) {
            const [formData, setFormData] = useState(chantier || { nom:'', lieu:'', dateDebut:'', dateFin:'', employees:[] });
            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h3>{chantier ? 'Modifier le chantier' : 'Nouveau chantier'}</h3>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Nom du chantier</label>
                                <input type="text" value={formData.nom} onChange={e => setFormData({...formData, nom: e.target.value})} required />
                            </div>
                            <div className="form-group">
                                <label>Lieu de travail (adresse complète)</label>
                                <textarea value={formData.lieu} onChange={e => setFormData({...formData, lieu: e.target.value})} rows="3" required placeholder="Ex: 123 Rue de la Paix, 59000 Lille" />
                            </div>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>Date de début</label>
                                    <input type="date" value={formData.dateDebut} onChange={e => setFormData({...formData, dateDebut: e.target.value})} required />
                                </div>
                                <div className="form-group">
                                    <label>Date de fin</label>
                                    <input type="date" value={formData.dateFin} onChange={e => setFormData({...formData, dateFin: e.target.value})} required />
                                </div>
                            </div>
                            <div className="modal-actions">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Annuler</button>
                                <button type="submit" className="btn btn-edit">Enregistrer</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ─── EXPORT TAB ───
        function ExportTab({ employees, onExport }) {
            const [selectedEmployee, setSelectedEmployee] = useState('');

            return (
                <div className="card">
                    <h3>Exporter les plannings</h3>
                    <div className="export-section">
                        <h4>Sélectionner un employé</h4>
                        <p style={{ color:'var(--text-light)', marginBottom:'14px', fontSize:'13px' }}>
                            Le planning annuel sera exporté au format Excel coloré avec un onglet par mois et un résumé CP
                        </p>
                        <div className="form-grid">
                            <div className="form-group">
                                <label>Employé</label>
                                <select value={selectedEmployee} onChange={e => setSelectedEmployee(e.target.value)}>
                                    <option value="">Sélectionner...</option>
                                    {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.nom}</option>)}
                                </select>
                            </div>
                            <div style={{ display:'flex', alignItems:'flex-end' }}>
                                <button className="btn btn-edit" onClick={() => selectedEmployee && onExport(selectedEmployee)} disabled={!selectedEmployee} style={{ width:'100%' }}>
                                    📥 Exporter le planning
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
